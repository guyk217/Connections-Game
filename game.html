<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> 拽砖专?</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #fff8dc;
      margin: 0;
      padding: 20px;
      text-align: center;
      direction: rtl;
    }
    h1 { font-size: 28px; margin-bottom: 10px; }
    h2 { font-size: 20px; margin-bottom: 20px; color: #555; }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin: 20px 0;
    }
    .tile {
      padding: 16px;
      background: #eee;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      user-select: none;
    }
    .tile.selected { background: #cce5ff; }
    .tile.correct { background: #d4edda; }
    .tile.removed { visibility: hidden; }
    .hearts {
      font-size: 24px;
      margin-bottom: 15px;
    }
    .message {
      font-size: 22px;
      margin-top: 30px;
    }
    .group-label {
      font-weight: bold;
      margin-top: 20px;
      color: #333;
    }
    .back-button {
      position: fixed;
      top: 10px;
      right: 10px;
      font-size: 24px;
      text-decoration: none;
    }
    button {
      padding: 10px 20px;
      font-size: 18px;
      margin-top: 20px;
      background: #333;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<a href="game.html" class="back-button">★</a>

<h1 id="level-title"> 拽砖专?</h1>
<h2 id="level-difficulty"></h2>
<div class="hearts" id="hearts"></div>
<div class="grid" id="board"></div>
<div class="message" id="message"></div>
<div id="play-again-container"></div>

<script>
let levels = [];
let selectedCategory = sessionStorage.getItem("selectedCategory") || null;
let selectedLevelIndex = sessionStorage.getItem("selectedLevel") || 0;
let current = null;
let selected = [];
let found = {};
let successWords = [];
let removedWords = [];
let hearts = 4;

fetch("https://raw.githubusercontent.com/guyk217/Connections-Game/main/levels.json")
  .then(res => res.json())
  .then(data => {
    levels = data.filter(l => l.category === selectedCategory);
    startLevel();
  });

function startLevel() {
  current = levels[selectedLevelIndex];
  document.getElementById("level-title").textContent = current.title;
  document.getElementById("level-difficulty").textContent = "专转 拽砖: " + (current.difficulty || " 注");
  selected = [];
  found = {};
  successWords = [];
  removedWords = [];
  hearts = 4;
  renderGame();
}

function renderGame() {
  const board = document.getElementById("board");
  board.innerHTML = "";
  document.getElementById("message").textContent = "";
  document.getElementById("hearts").textContent = "┓".repeat(hearts);

  current.words.forEach(word => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.textContent = word;
    if (selected.includes(word)) tile.classList.add("selected");
    if (successWords.includes(word)) tile.classList.add("correct");
    if (removedWords.includes(word)) tile.classList.add("removed");
    tile.onclick = () => handleSelect(word);
    board.appendChild(tile);
  });

  for (const group in found) {
    const label = document.createElement("div");
    label.className = "group-label";
    label.textContent = `锔 ${group}`;
    board.appendChild(label);
  }
}

function handleSelect(word) {
  if (selected.includes(word)) {
    selected = selected.filter(w => w !== word);
  } else if (selected.length < 4) {
    selected.push(word);
  }
  renderGame();

  if (selected.length === 4) {
    setTimeout(handleCheck, 300);
  }
}

function handleCheck() {
  const match = Object.entries(current.groups).find(([group, words]) =>
    words.every(w => selected.includes(w)) && !found[group]);

  if (match) {
    const [group, words] = match;
    found[group] = [...words];
    successWords = [...words];
    selected = [];
    setTimeout(() => {
      removedWords.push(...words);
      current.words = current.words.filter(w => !removedWords.includes(w));
      successWords = [];
      renderGame();

      if (Object.keys(found).length === 4) {
        setTimeout(() => showEndMessage(true), 500);
      }
    }, 800);
  } else {
    hearts--;
    selected = [];
    if (hearts === 0) {
      simulateFailureReveal();
    } else {
      renderGame();
    }
  }
}

function simulateFailureReveal() {
  const groups = Object.entries(current.groups).filter(([group]) => !found[group]);
  let i = 0;
  selected = [];
  successWords = [];
  removedWords = [];

  function revealNextGroup() {
    if (i >= groups.length) {
      setTimeout(() => showEndMessage(false), 800);
      return;
    }

    const [group, words] = groups[i++];
    found[group] = [...words];
    successWords = [...words];
    renderGame();

    setTimeout(() => {
      removedWords.push(...words);
      current.words = current.words.filter(w => !removedWords.includes(w));
      successWords = [];
      renderGame();
      setTimeout(revealNextGroup, 1000);
    }, 1000);
  }

  revealNextGroup();
}

function showEndMessage(success) {
  const msg = document.getElementById("message");
  const container = document.getElementById("play-again-container");
  container.innerHTML = "";
  if (success) {
    msg.innerHTML = " !  驻转专转 ";
  } else {
    msg.innerHTML = " 专!  专 砖";
  }
  const btn = document.createElement("button");
  btn.textContent = "砖拽 砖";
  btn.onclick = () => location.href = "game.html";
  container.appendChild(btn);
}
</script>
</body>
</html>