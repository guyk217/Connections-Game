<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title> 拽砖专?</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
      background: #fff8dc;
      text-align: center;
      position: relative;
    }
    h2 { margin-bottom: 10px; }
    .level { margin: 5px; padding: 10px; background: #fff; border: 1px solid #ccc; cursor: pointer; transition: 0.3s; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-top: 15px; transition: all 0.5s ease; }
    .tile {
      background: white; padding: 12px; border: 1px solid #999; cursor: pointer;
      user-select: none; border-radius: 5px; transition: 0.4s ease;
    }
    .tile.selected { background: #ccc; }
    .tile.removed { transform: translateY(-50px); opacity: 0; }
    .tile.shake { animation: shake 0.3s; background: #fdd; }
    .tile.error { background: #f8d7da; color: #721c24; }
    .tile.success { background: #a8f0a5; animation: pop 0.4s ease; }
    .tile.newly-formed { background: #d4edda; animation: mergeAnim 1.2s ease forwards; }
    @keyframes shake {
      0% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      50% { transform: translateX(5px); }
      75% { transform: translateX(-3px); }
      100% { transform: translateX(0); }
    }
    @keyframes pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.15); }
      100% { transform: scale(1); }
    }
    @keyframes mergeAnim {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); background: #c3e6cb; }
      100% { transform: scale(1); opacity: 1; }
    }
    .group { margin: 10px 0; padding: 5px; font-weight: bold; border-radius: 4px; color: black; }
    .controls { margin-top: 10px; }
    button {
      margin: 5px; padding: 8px 16px; font-size: 16px;
      border-radius: 6px; border: none; background: #555; color: white;
    }
    .hearts { font-size: 18px; margin-top: 10px; }
    .notice { margin-top: 10px; color: #333; font-weight: bold; }
    #backBtn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
  </style>
</head>
<body>
<button id="backBtn" onclick="window.location.href='game.html'">★</button>
<h2>专 砖:</h2>
<div id="level-list"></div>

<script>
let current = null;
let selected = [];
let hearts = 6;
let found = {};
let removedWords = [];
let shakingWords = [];
let successWords = [];
let noticeText = "";
let noticeTimeout;
const defaultColors = ["#A8D5BA", "#FFE066", "#FFB347", "#F49AC2"];
let levels = [];

fetch("levels.json")
  .then(res => res.json())
  .then(data => {
    levels = data;
    showLevels();
  });

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}

function showLevels() {
  document.body.innerHTML = `
    <button id="backBtn" onclick="window.location.href='game.html'">★</button>
    <h2>专 砖:</h2>
    <div id='level-list'></div>`;
  const container = document.getElementById("level-list");
  levels.forEach((lvl, idx) => {
    let div = document.createElement("div");
    div.className = "level";
    div.innerHTML = `<b>${lvl.title}</b><br><small>专转 拽砖: ${lvl.difficulty || ' 爪'}</small>`;
    div.onclick = () => startLevel(idx);
    container.appendChild(div);
  });
}

function getColor(group, index) {
  let c = current.colors?.[group];
  if (!c || !c.trim()) {
    return defaultColors[index % defaultColors.length];
  }
  return c;
}

function startLevel(index) {
  current = JSON.parse(JSON.stringify(levels[index]));
  let groupKeys = Object.keys(current.groups);
  current.groupColorMap = {};
  groupKeys.forEach((g, i) => {
    current.groupColorMap[g] = getColor(g, i);
  });
  current.words = shuffle([...current.words]);
  selected = [];
  found = {};
  hearts = 6;
  removedWords = [];
  shakingWords = [];
  successWords = [];
  noticeText = "";
  renderGame();
}

function isHintGroupFound() {
  if (!current.hintPair || current.hintPair.length < 2) return false;
  return Object.entries(current.groups).some(([group, arr]) =>
    arr.includes(current.hintPair[0]) &&
    arr.includes(current.hintPair[1]) &&
    found[group]
  );
}

function renderGame() {
  document.body.innerHTML = `
  <button id="backBtn" onclick="window.location.href='game.html'">★</button>
  <h2>${current.title}</h2>
  <div><small>专转 拽砖: ${current.difficulty || " 爪"}</small></div>`;
  
  
  for (let group in found) {
    let div = document.createElement("div");
    div.className = "group";
    div.style.background = current.groupColorMap[group];
    div.innerText = group + ": " + found[group].join(", ");
    document.body.appendChild(div);
  }

  let grid = document.createElement("div");
  grid.className = "grid";
  current.words.forEach(word => {
    let div = document.createElement("div");
    div.className = "tile";
    if (selected.includes(word)) div.classList.add("selected");
    if (removedWords.includes(word)) div.classList.add("removed");
    if (shakingWords.includes(word)) div.classList.add("shake");
    if (successWords.includes(word)) div.classList.add("newly-formed");
    div.innerText = word;
    div.onclick = () => {
      if (selected.includes(word)) {
        selected = selected.filter(w => w !== word);
      } else if (selected.length < 4) {
        selected.push(word);
      }
      renderGame();
    };
    grid.appendChild(div);
  });
  document.body.appendChild(grid);

  let controls = document.createElement("div");
  controls.className = "controls";

  let check = document.createElement("button");
  check.innerText = "砖专";
  check.onclick = handleCheck;
  controls.appendChild(check);

  let clear = document.createElement("button");
  clear.innerText = "拽";
  clear.onclick = () => {
    selected = [];
    renderGame();
  };
  controls.appendChild(clear);

  let hintBtn = document.createElement("button");
  if (!current.hintPair || current.hintPair.length < 2 || isHintGroupFound()) {
    hintBtn.innerText = "专  ";
    hintBtn.disabled = true;
    hintBtn.style.opacity = 0.5;
  } else {
    hintBtn.innerText = " 专";
    hintBtn.onclick = () => {
      selected = [...current.hintPair];
      renderGame();
    };
  }
  controls.appendChild(hintBtn);

  document.body.appendChild(controls);

  let heartBar = document.createElement("div");
  heartBar.className = "hearts";
  heartBar.innerText = "┓".repeat(hearts) + "".repeat(6 - hearts);
  document.body.appendChild(heartBar);

  if (noticeText) {
    let notice = document.createElement("div");
    notice.className = "notice";
    notice.innerText = noticeText;
    document.body.appendChild(notice);
  }
}

function handleCheck() {
  if (selected.length !== 4) return;

  for (let group in current.groups) {
    let target = current.groups[group];
    let matches = selected.filter(w => target.includes(w));
    if (matches.length === 4) {
      found[group] = [...target];
      successWords = [...target];
      removedWords.push(...target);
      selected = [];
      renderGame();
      setTimeout(() => {
        current.words = current.words.filter(w => !removedWords.includes(w));
        removedWords = [];
        successWords = [];
        if (Object.keys(found).length === 4) {
          setTimeout(() => showEndMessage(true), 1200);
        } else {
          renderGame();
        }
      }, 1000);
      return;
    } else if (matches.length === 3) {
      hearts--;
      shakingWords = selected.slice();
      noticeText = "爪拽转 志3 转 4. 砖 住转.";
      renderGame();
      clearTimeout(noticeTimeout);
      noticeTimeout = setTimeout(() => {
        shakingWords = [];
        selected = [];
        noticeText = "";
        renderGame();
      }, 1000);
      return;
    }
  }

  hearts--;
  shakingWords = selected.slice();
  renderGame();
  setTimeout(() => {
    shakingWords = [];
    selected = [];
    renderGame();
  }, 400);

  if (hearts === 0) {
    simulateFailureReveal();
  }
}

function simulateFailureReveal() {
  const groups = Object.entries(current.groups).filter(([g]) => !found[g]);
  let i = 0;
  selected = [];
  successWords = [];
  removedWords = [];

  function revealNextGroup() {
    if (i >= groups.length) {
      setTimeout(() => showEndMessage(false), 800);
      return;
    }
    let [group, words] = groups[i++];
    found[group] = [...words];
    successWords = [...words];
    renderGame();

    setTimeout(() => {
      removedWords.push(...words);
      current.words = current.words.filter(w => !removedWords.includes(w));
      successWords = [];
      renderGame();
      setTimeout(revealNextGroup, 1000);
    }, 1000);
  }

  revealNextGroup();
}

function showEndMessage(success) {
  document.body.innerHTML = `
    <button id="backBtn" onclick="window.location.href='game.html'">★</button>
    <h2>${success ? "注!  爪转 转  拽爪转!" : " 专!  专 砖"}</h2>
    <button onclick="showLevels()">砖拽 砖</button>`;
}
</script>
</body>
</html>