<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>מה הקשר? - עורך שלבים</title>
  <style>
    body {
      font-family: sans-serif;
      background: #fff8dc;
      margin: 0;
      padding: 0;
      text-align: center;
    }
    h2 {
      margin-top: 20px;
    }
    .container {
      max-width: 700px;
      margin: auto;
      padding: 15px;
      background: white;
      border-radius: 10px;
    }
    .group {
      margin-bottom: 20px;
      border-top: 1px solid #ccc;
      padding-top: 10px;
    }
    input[type="text"], select {
      width: 90%;
      padding: 8px;
      margin: 5px 0;
      font-size: 16px;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }
    .tile {
      padding: 10px;
      border: 1px solid #ccc;
      background: #f0f0f0;
      cursor: pointer;
    }
    .tile.selected {
      background: #add8e6;
    }
    .hint-buttons {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .hint-buttons button {
      margin: 5px;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div id="app"></div>

  <script>
    const owner = "guyk217";
    const repo = "Connections-Game";
    const path = "levels.json";
    let token = localStorage.getItem("github_token") || "";
    let levels = [];
    let editingIndex = null;
    let currentSha = "";

    async function loadLevels() {
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        headers: { Authorization: `Bearer ${token}` }
      });
      const data = await res.json();
      currentSha = data.sha;
      const content = atob(data.content);
      return JSON.parse(content);
    }

    async function saveLevels(updatedLevels) {
      const content = btoa(JSON.stringify(updatedLevels, null, 2));
      const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Update levels",
          content: content,
          sha: currentSha
        })
      });
      return res.ok;
    }

    function showLogin() {
      document.getElementById("app").innerHTML = `
        <div class="container">
          <h2>🔑 הזן טוקן GitHub</h2>
          <input type="text" id="tokenInput" placeholder="הדבק את הטוקן שלך כאן" />
          <br/>
          <button onclick="submitToken()">המשך</button>
        </div>`;
    }

    function submitToken() {
      token = document.getElementById("tokenInput").value.trim();
      if (token) {
        localStorage.setItem("github_token", token);
        start();
      }
    }

    async function start() {
      document.getElementById("app").innerHTML = "<h2>טוען שלבים...</h2>";
      try {
        levels = await loadLevels();
        showLevelMenu();
      } catch (e) {
        document.getElementById("app").innerHTML = `<div class="container"><h2>שגיאה בטעינת השלבים</h2><pre>${e}</pre></div>`;
      }
    }

    function showLevelMenu() {
      let html = `<div class="container"><h2>בחר שלב לעריכה</h2>`;
      levels.forEach((lvl, i) => {
        html += `<div><button onclick="editLevel(${i})">${lvl.title}</button></div>`;
      });
      html += `<hr/><button onclick="newLevel()">➕ שלב חדש</button></div>`;
      document.getElementById("app").innerHTML = html;
    }

    function newLevel() {
      editingIndex = null;
      editLevelData({
        title: "",
        words: Array(16).fill(""),
        groups: {
          "": ["", "", "", ""],
          "": ["", "", "", ""],
          "": ["", "", "", ""],
          "": ["", "", "", ""]
        },
        hintPair: [],
        difficulty: ""
      });
    }

    function editLevel(index) {
      editingIndex = index;
      const level = levels[index];
      editLevelData(level);
    }

    function editLevelData(level) {
      let html = `<div class="container"><h2>עריכת שלב</h2>
        <input type="text" id="title" value="${level.title}" placeholder="שם שלב" />
        <input type="text" id="difficulty" value="${level.difficulty || ""}" placeholder="קושי (לא חובה)" />
      `;

      const groupNames = Object.keys(level.groups);
      groupNames.forEach((name, i) => {
        const words = level.groups[name];
        html += `<div class="group">
          <input type="text" id="group-name-${i}" value="${name}" placeholder="שם קבוצה" />
          <div class="grid">`;
        words.forEach((w, j) => {
          html += `<input type="text" id="group-${i}-word-${j}" value="${w}" />`;
        });
        html += `</div></div>`;
      });

      html += `
        <button onclick="goToHint()">המשך לבחירת רמז</button>
        <button onclick="showLevelMenu()">חזור</button>
      </div>`;

      document.getElementById("app").innerHTML = html;
    }

    function goToHint() {
      const title = document.getElementById("title").value.trim();
      const difficulty = document.getElementById("difficulty").value.trim();
      const groups = {};
      const words = [];

      for (let i = 0; i < 4; i++) {
        const name = document.getElementById(`group-name-${i}`).value.trim();
        const groupWords = [];
        for (let j = 0; j < 4; j++) {
          const w = document.getElementById(`group-${i}-word-${j}`).value.trim();
          groupWords.push(w);
          words.push(w);
        }
        groups[name] = groupWords;
      }

      let html = `<div class="container"><h2>בחר זוג מילים לרמז</h2><div class="grid">`;
      words.forEach(w => {
        html += `<div class="tile" onclick="selectHint(this, '${w}')">${w}</div>`;
      });
      html += `</div><div class="hint-buttons">
        <button onclick="copyJson()">📋 העתק JSON</button>
        <button onclick="copySha()">🔑 העתק SHA</button>
        <button onclick="submitHint('${title}', '${difficulty}', '${JSON.stringify(groups)}', '${JSON.stringify(words)}')">שמור</button>
        <button onclick="start()">ביטול</button>
      </div></div>`;

      document.getElementById("app").innerHTML = html;
    }

    let hint = [];

    function selectHint(el, word) {
      const tiles = document.querySelectorAll(".tile");
      if (hint.length === 0) {
        hint.push(word);
        el.classList.add("selected");
        const valid = getGroupOfWord(word);
        tiles.forEach(t => {
          if (!valid.includes(t.innerText)) t.classList.add("hidden");
        });
      } else if (hint.length === 1 && getGroupOfWord(hint[0]).includes(word)) {
        hint.push(word);
        el.classList.add("selected");
      } else {
        hint = [];
        tiles.forEach(t => t.classList.remove("selected", "hidden"));
      }
    }

    function getGroupOfWord(word) {
      for (const group of Object.values(JSON.parse(sessionStorage.getItem("groups")))) {
        if (group.includes(word)) return group;
      }
      return [];
    }

    function copyJson() {
      const data = {
        title: document.getElementById("title").value.trim(),
        difficulty: document.getElementById("difficulty").value.trim(),
        words: Array.from(document.querySelectorAll(".tile")).map(t => t.innerText),
        groups: JSON.parse(sessionStorage.getItem("groups")),
        hintPair: hint
      };
      navigator.clipboard.writeText(JSON.stringify(data, null, 2));
      alert("הועתק ל־Clipboard");
    }

    function copySha() {
      navigator.clipboard.writeText(currentSha || "SHA לא נטען");
      alert("SHA הועתק");
    }

    async function submitHint(title, difficulty, groupsStr, wordsStr) {
      if (hint.length !== 2) return alert("בחר שתי מילים לרמז");
      const newLevel = {
        title,
        difficulty,
        words: JSON.parse(wordsStr),
        groups: JSON.parse(groupsStr),
        hintPair: hint
      };
      if (editingIndex != null) levels[editingIndex] = newLevel;
      else levels.push(newLevel);
      const success = await saveLevels(levels);
      if (success) start();
      else alert("שמירה נכשלה");
    }

    window.onload = () => {
      if (!token) showLogin();
      else start();
    };
  </script>
</body>
</html>