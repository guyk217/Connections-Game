<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ğŸ”§ ×¢×¨×™×›×ª ×©×œ×‘×™×</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f7f7f7;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 26px;
      margin-bottom: 20px;
    }
    input, button, select {
      font-size: 18px;
      padding: 8px;
      margin: 6px;
    }
    .level-row {
      background: #fff;
      margin: 6px auto;
      padding: 10px;
      border: 1px solid #ccc;
      width: 90%;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .editor-section {
      background: #fff;
      padding: 20px;
      margin-top: 20px;
      width: 90%;
      margin-left: auto;
      margin-right: auto;
      border: 1px solid #ccc;
    }
    .group-box {
      border-top: 1px solid #ddd;
      padding-top: 10px;
      margin-top: 10px;
    }
    .word-box {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
    }
    .word {
      border: 1px solid #ccc;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .selected {
      background: #add8e6;
    }
    .hidden {
      display: none;
    }
  </style>
</head>
<body>

<div id="login-section">
  <h1>ğŸ”‘ ×”×ª×—×‘×¨×•×ª ×¢× ×˜×•×§×Ÿ</h1>
  <input type="password" id="token-input" placeholder="×”×›× ×¡ ×˜×•×§×Ÿ GitHub ×©×œ×š">
  <br>
  <button onclick="loadLevels()">×”××©×š</button>
</div>

<div id="menu-section" class="hidden">
  <h1>ğŸ“‹ × ×™×”×•×œ ×©×œ×‘×™×</h1>
  <button onclick="startNewLevel()">â• ×™×¦×™×¨×ª ×©×œ×‘ ×—×“×©</button>
  <div id="levels-list"></div>
</div>

<div id="editor-section" class="editor-section hidden"></div>

<script>
  let token = "";
  let levels = [];
  let selectedLevelIndex = null;
  let editingLevel = null;

  function show(id) {
    document.querySelectorAll(".hidden").forEach(el => el.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  async function loadLevels() {
    token = document.getElementById("token-input").value.trim();
    if (!token) return alert("× × ×œ×”×›× ×™×¡ ×˜×•×§×Ÿ");

    try {
      const res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
        headers: { Authorization: `token ${token}` }
      });
      const data = await res.json();
      const content = atob(data.content);
      levels = JSON.parse(content);
      show("menu-section");
      renderLevelList();
    } catch (e) {
      alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×©×œ×‘×™×: " + e.message);
    }
  }

  function renderLevelList() {
    const container = document.getElementById("levels-list");
    container.innerHTML = "";
    levels.forEach((lvl, idx) => {
      const row = document.createElement("div");
      row.className = "level-row";
      row.innerHTML = `
        <span>${lvl.title}</span>
        <div>
          <button onclick="editLevel(${idx})">âœï¸ ×¢×¨×™×›×”</button>
          <button onclick="deleteLevel(${idx})">ğŸ—‘ï¸ ××—×™×§×”</button>
        </div>
      `;
      container.appendChild(row);
    });
  }

  function startNewLevel() {
    selectedLevelIndex = null;
    editingLevel = {
      title: "",
      words: [],
      groups: {
        "×§×˜×’×•×¨×™×” 1": ["", "", "", ""],
        "×§×˜×’×•×¨×™×” 2": ["", "", "", ""],
        "×§×˜×’×•×¨×™×” 3": ["", "", "", ""],
        "×§×˜×’×•×¨×™×” 4": ["", "", "", ""]
      },
      colors: {},
      hintPair: []
    };
    renderEditor();
  }

  function editLevel(index) {
    selectedLevelIndex = index;
    editingLevel = JSON.parse(JSON.stringify(levels[index]));
    renderEditor();
  }

  function deleteLevel(index) {
    if (!confirm(`×”×× ×œ××—×•×§ ××ª "${levels[index].title}"?`)) return;
    levels.splice(index, 1);
    saveToGitHub();
  }

  function renderEditor() {
    show("editor-section");
    const container = document.getElementById("editor-section");
    container.innerHTML = "";

    const titleInput = document.createElement("input");
    titleInput.value = editingLevel.title;
    titleInput.placeholder = "×©× ×”×©×œ×‘";
    titleInput.oninput = () => editingLevel.title = titleInput.value;
    container.appendChild(titleInput);

    Object.entries(editingLevel.groups).forEach(([groupName, words], i) => {
      const groupBox = document.createElement("div");
      groupBox.className = "group-box";

      const groupNameInput = document.createElement("input");
      groupNameInput.value = groupName;
      groupNameInput.placeholder = `×©× ×§×˜×’×•×¨×™×” ${i+1}`;
      groupBox.appendChild(groupNameInput);

      const colorButton = document.createElement("button");
      colorButton.textContent = "×‘×—×¨ ×¦×‘×¢ (×œ× ×—×•×‘×”)";
      colorButton.onclick = () => {
        const picked = prompt("×”×›× ×¡ ×§×•×“ ×¦×‘×¢ (×œ××©×œ: #FF0000):", editingLevel.colors[groupName] || "");
        if (picked !== null) editingLevel.colors[groupName] = picked;
      };
      groupBox.appendChild(colorButton);

      const wordsRow = document.createElement("div");
      wordsRow.className = "word-box";
      words.forEach((word, wi) => {
        const input = document.createElement("input");
        input.value = word;
        input.placeholder = `××™×œ×” ${wi+1}`;
        input.oninput = () => {
          editingLevel.groups[groupName][wi] = input.value;
          refreshWords();
        };
        wordsRow.appendChild(input);
      });
      groupBox.appendChild(wordsRow);
      container.appendChild(groupBox);
    });

    const hintBtn = document.createElement("button");
    hintBtn.textContent = "×”××©×š â†’ ×‘×—×¨ ×¨××–";
    hintBtn.onclick = () => {
      editingLevel.words = Object.values(editingLevel.groups).flat();
      renderHintSelector();
    };
    container.appendChild(hintBtn);

    const cancelBtn = document.createElement("button");
    cancelBtn.textContent = "â†©ï¸ ×—×–×•×¨";
    cancelBtn.onclick = () => show("menu-section");
    container.appendChild(cancelBtn);
  }

  function refreshWords() {
    editingLevel.words = Object.values(editingLevel.groups).flat();
  }

  function renderHintSelector() {
    show("editor-section");
    const container = document.getElementById("editor-section");
    container.innerHTML = "<h2>×‘×—×¨ ×¨××– (×©×ª×™ ××™×œ×™× ×××•×ª×” ×§×˜×’×•×¨×™×”)</h2>";

    let selectedHint = [...editingLevel.hintPair];

    Object.entries(editingLevel.groups).forEach(([group, words]) => {
      const row = document.createElement("div");
      row.className = "word-box";
      words.forEach(word => {
        const w = document.createElement("div");
        w.className = "word";
        w.innerText = word;
        if (selectedHint.includes(word)) w.classList.add("selected");
        w.onclick = () => {
          if (selectedHint.includes(word)) {
            selectedHint = selectedHint.filter(w => w !== word);
          } else if (selectedHint.length < 2) {
            selectedHint.push(word);
          }
          renderHintSelector();
        };
        row.appendChild(w);
      });
      container.appendChild(row);
    });

    const saveBtn = document.createElement("button");
    saveBtn.textContent = "ğŸ’¾ ×©××•×¨";
    saveBtn.disabled = selectedHint.length !== 2;
    saveBtn.onclick = () => {
      editingLevel.hintPair = selectedHint;
      if (selectedLevelIndex != null) {
        levels[selectedLevelIndex] = editingLevel;
      } else {
        levels.push(editingLevel);
      }
      saveToGitHub();
    };
    container.appendChild(saveBtn);

    const backBtn = document.createElement("button");
    backBtn.textContent = "â†©ï¸ ×—×–×•×¨";
    backBtn.onclick = renderEditor;
    container.appendChild(backBtn);
  }

  async function saveToGitHub() {
    const url = "https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json";
    const getRes = await fetch(url, {
      headers: { Authorization: `token ${token}` }
    });
    const getData = await getRes.json();

    const content = btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2))));

    const res = await fetch(url, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        message: "Update levels.json",
        content,
        sha: getData.sha
      })
    });

    if (res.ok) {
      alert("× ×©××¨ ×‘×”×¦×œ×—×”!");
      show("menu-section");
      renderLevelList();
    } else {
      alert("×©×’×™××” ×‘×©××™×¨×”.");
    }
  }
</script>
</body>
</html>