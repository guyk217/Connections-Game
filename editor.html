<!-- editor.html -->
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ניהול שלבים</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f9f9f9;
      direction: rtl;
    }
    .container {
      max-width: 600px;
      margin: auto;
      padding: 20px;
    }
    h1, h2 {
      text-align: center;
    }
    input, button, select {
      font-size: 16px;
      padding: 8px;
      margin: 5px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .group-block {
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 15px;
    }
    .words-row {
      display: flex;
      gap: 10px;
      margin: 5px 0;
    }
    .words-row input {
      flex: 1;
    }
    .color-btn {
      background: #eee;
      border: 1px solid #ccc;
      text-align: center;
      cursor: pointer;
    }
    .level-entry {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border: 1px solid #ddd;
      padding: 10px;
      margin: 5px 0;
      background: #fff;
    }
    .level-entry button {
      margin-right: 5px;
    }
    .hint-board {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      margin-top: 20px;
    }
    .hint-word {
      padding: 12px;
      border: 1px solid #aaa;
      background: white;
      text-align: center;
      border-radius: 4px;
      cursor: pointer;
      transition: 0.2s;
    }
    .hint-word.selected {
      background: #d1ecf1;
    }
  </style>
</head>
<body>
<div class="container" id="app"></div>

<script>
const REPO = "guyk217/Connections-Game";
const FILE = "levels.json";
let token = localStorage.getItem("github_token") || "";
let levels = [];
let editingIndex = null;
let editingLevel = null;
let selectedHintPair = [];

function renderLogin() {
  document.getElementById("app").innerHTML = `
    <h1>התחברות לניהול שלבים</h1>
    <input type="password" id="tokenInput" placeholder="הכנס טוקן GitHub" />
    <button onclick="saveToken()">המשך</button>
  `;
}
function saveToken() {
  token = document.getElementById("tokenInput").value.trim();
  if (!token) return alert("יש להזין טוקן.");
  localStorage.setItem("github_token", token);
  loadLevels();
}
async function githubRequest(method, url, body = null) {
  const headers = {
    Authorization: `token ${token}`,
    Accept: "application/vnd.github.v3+json"
  };
  const res = await fetch(url, {
    method,
    headers,
    body: body ? JSON.stringify(body) : undefined,
  });
  if (!res.ok) throw new Error(await res.text());
  return res.json();
}
async function loadLevels() {
  try {
    const res = await githubRequest("GET", `https://api.github.com/repos/${REPO}/contents/${FILE}`);
    const content = atob(res.content);
    levels = JSON.parse(content);
    window._sha = res.sha;
    renderLevelList();
  } catch (e) {
    alert("שגיאה בטעינת השלבים: " + e.message);
    renderLogin();
  }
}
function renderLevelList() {
  let html = `<h2>בחר שלב לעריכה</h2>`;
  levels.forEach((lvl, i) => {
    html += `
      <div class="level-entry">
        <span>${lvl.title}</span>
        <div>
          <button onclick="editLevel(${i})">📝 ערוך</button>
          <button onclick="deleteLevel(${i})">🗑️ מחק</button>
        </div>
      </div>
    `;
  });
  html += `<button onclick="newLevel()">➕ צור שלב חדש</button>`;
  document.getElementById("app").innerHTML = html;
}
function newLevel() {
  editingIndex = null;
  selectedHintPair = [];
  editingLevel = {
    title: "",
    words: [],
    groups: {
      "קבוצה 1": ["", "", "", ""],
      "קבוצה 2": ["", "", "", ""],
      "קבוצה 3": ["", "", "", ""],
      "קבוצה 4": ["", "", "", ""]
    },
    colors: {},
    hintPair: []
  };
  renderEditForm();
}
function editLevel(i) {
  editingIndex = i;
  selectedHintPair = [];
  editingLevel = JSON.parse(JSON.stringify(levels[i]));
  renderEditForm();
}
function deleteLevel(i) {
  if (!confirm("למחוק שלב זה?")) return;
  levels.splice(i, 1);
  saveToGitHub("שלב נמחק");
}
function renderEditForm() {
  let html = `<h2>${editingIndex !== null ? "עריכת שלב" : "שלב חדש"}</h2>`;
  html += `<input placeholder="שם השלב" value="${editingLevel.title}" onchange="editingLevel.title=this.value" />`;

  Object.entries(editingLevel.groups).forEach(([name, words], i) => {
    html += `<div class="group-block">
      <strong>שם קבוצה ${i + 1}:</strong>
      <input value="${name}" onchange="renameGroup('${name}', this.value)" />
      <div class="words-row">
        ${words.map((w, j) => `<input value="${w}" onchange="editingLevel.groups['${name}'][${j}]=this.value" />`).join('')}
      </div>
      <button class="color-btn" onclick="pickColor('${name}')">בחר צבע (לא חובה)</button>
    </div>`;
  });

  html += `
    <br><button onclick="chooseHint()">בחר רמז</button>
    <br><br><button onclick="renderLevelList()">חזור</button>
  `;

  document.getElementById("app").innerHTML = html;
}
function renameGroup(oldName, newName) {
  if (!newName || oldName === newName) return;
  editingLevel.groups[newName] = editingLevel.groups[oldName];
  delete editingLevel.groups[oldName];
  if (editingLevel.colors[oldName]) {
    editingLevel.colors[newName] = editingLevel.colors[oldName];
    delete editingLevel.colors[oldName];
  }
  renderEditForm();
}
function pickColor(groupName) {
  const color = prompt("הזן קוד צבע (כמו #FFAA00) או השאר ריק");
  if (color !== null) {
    editingLevel.colors[groupName] = color;
  }
}
function chooseHint() {
  const allWords = Object.values(editingLevel.groups).flat();
  editingLevel.words = allWords;

  const board = allWords.map(w => `
    <div class="hint-word ${selectedHintPair.includes(w) ? 'selected' : ''}"
      onclick="toggleHint('${w}')">${w}</div>`).join("");

  document.getElementById("app").innerHTML = `
    <h2>בחר רמז (2 מילים מאותה קבוצה בלבד)</h2>
    <div class="hint-board">${board}</div>
    <br>
    <button onclick="renderEditForm()">חזור</button>
    <button onclick="saveLevel()" ${selectedHintPair.length !== 2 ? "disabled" : ""}>💾 שמור</button>
  `;
}
function toggleHint(word) {
  if (selectedHintPair.includes(word)) {
    selectedHintPair = selectedHintPair.filter(w => w !== word);
  } else if (selectedHintPair.length < 2) {
    selectedHintPair.push(word);
  }
  chooseHint();
}
function isValidHint() {
  if (selectedHintPair.length !== 2) return false;
  return Object.values(editingLevel.groups).some(group =>
    group.includes(selectedHintPair[0]) &&
    group.includes(selectedHintPair[1])
  );
}
function saveLevel() {
  if (!isValidHint()) return alert("בחר רמז חוקי (2 מילים מאותה קבוצה)");
  editingLevel.hintPair = selectedHintPair;
  editingLevel.words = Object.values(editingLevel.groups).flat();

  if (editingIndex !== null) {
    levels[editingIndex] = editingLevel;
  } else {
    levels.push(editingLevel);
  }

  saveToGitHub("עודכן שלב");
}
async function saveToGitHub(msg) {
  try {
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2))));
    await githubRequest("PUT", `https://api.github.com/repos/${REPO}/contents/${FILE}`, {
      message: msg,
      content,
      sha: window._sha
    });
    alert("נשמר בהצלחה!");
    loadLevels();
  } catch (e) {
    alert("שגיאה בשמירה: " + e.message);
  }
}

// התחלה
if (!token) renderLogin();
else loadLevels();
</script>
</body>
</html>