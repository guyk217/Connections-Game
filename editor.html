<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>◊¢◊ï◊®◊ö ◊©◊ú◊ë◊ô◊ù</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f2f2f2;
      padding: 20px;
      direction: rtl;
      text-align: right;
    }
    h1 {
      font-size: 26px;
      text-align: center;
      margin-bottom: 30px;
    }
    .field, .button-row {
      background: white;
      padding: 12px 16px;
      margin-bottom: 12px;
      border-radius: 8px;
      border: 1px solid #ddd;
      cursor: pointer;
    }
    .field-title {
      font-weight: bold;
      margin-bottom: 6px;
    }
    .color-button {
      display: inline-block;
      padding: 6px 12px;
      background: #eee;
      border-radius: 6px;
      cursor: pointer;
      border: 1px solid #ccc;
      margin-top: 6px;
    }
    .divider {
      border-top: 1px solid #ccc;
      margin: 20px 0;
    }
    .center {
      text-align: center;
    }
    .btn {
      background: #333;
      color: white;
      padding: 10px 20px;
      font-size: 18px;
      border: none;
      border-radius: 6px;
      margin: 5px;
      cursor: pointer;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .tile {
      background: white;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      text-align: center;
      cursor: pointer;
    }
    .tile.selected {
      background: #aaf;
    }
    #modal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #modalContent {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 300px;
    }
    #modalContent input {
      width: 100%;
      padding: 8px;
      margin-top: 10px;
    }
    #modalContent button {
      margin-top: 15px;
    }
  </style>
</head>
<body>

<div id="app"></div>

<div id="modal" style="display:none">
  <div id="modalContent">
    <div id="modalTitle"></div>
    <input type="text" id="modalInput">
    <div class="center">
      <button class="btn" onclick="closeModal(true)">◊©◊û◊ï◊®</button>
    </div>
  </div>
</div>

<script>
let localStorageKey = "levels_json_editor";
let levels = JSON.parse(localStorage.getItem(localStorageKey) || "[]");
let current = null;
let editing = null;
let stage = 'menu'; // or 'edit' or 'hint'

function saveToLocal() {
  localStorage.setItem(localStorageKey, JSON.stringify(levels));
}

function render() {
  const app = document.getElementById("app");
  app.innerHTML = "";

  if (stage === 'menu') {
    let title = document.createElement("h1");
    title.innerText = "◊†◊ô◊î◊ï◊ú ◊©◊ú◊ë◊ô◊ù";
    app.appendChild(title);

    levels.forEach((lvl, idx) => {
      let row = document.createElement("div");
      row.className = "field";
      row.innerText = lvl.title;
      row.onclick = () => {
        editing = JSON.parse(JSON.stringify(lvl));
        current = idx;
        stage = 'edit';
        render();
      };
      app.appendChild(row);
    });

    let btn = document.createElement("button");
    btn.className = "btn";
    btn.innerText = "‚ûï ◊©◊ú◊ë ◊ó◊ì◊©";
    btn.onclick = () => {
      editing = {
        title: "",
        groups: {
          "◊ß◊ë◊ï◊¶◊î 1": ["", "", "", ""],
          "◊ß◊ë◊ï◊¶◊î 2": ["", "", "", ""],
          "◊ß◊ë◊ï◊¶◊î 3": ["", "", "", ""],
          "◊ß◊ë◊ï◊¶◊î 4": ["", "", "", ""]
        },
        colors: {},
        hintPair: []
      };
      current = -1;
      stage = 'edit';
      render();
    };
    app.appendChild(btn);
    return;
  }

  if (stage === 'edit') {
    let title = document.createElement("h1");
    title.innerText = "◊¢◊®◊ô◊õ◊™ ◊©◊ú◊ë";
    app.appendChild(title);

    addEditableField(app, "◊©◊ù ◊î◊©◊ú◊ë", editing.title, v => editing.title = v);

    for (let [groupName, words] of Object.entries(editing.groups)) {
      addEditableField(app, "◊©◊ù ◊ß◊ë◊ï◊¶◊î", groupName, newName => {
        editing.groups[newName] = editing.groups[groupName];
        delete editing.groups[groupName];
        if (editing.colors[groupName]) {
          editing.colors[newName] = editing.colors[groupName];
          delete editing.colors[groupName];
        }
      });
      let colorBtn = document.createElement("div");
      colorBtn.className = "color-button";
      colorBtn.innerText = editing.colors[groupName] || "◊ë◊ó◊® ◊¶◊ë◊¢ (◊ú◊ê ◊ó◊ï◊ë◊î)";
      colorBtn.onclick = () => {
        let picker = document.createElement("input");
        picker.type = "color";
        picker.value = editing.colors[groupName] || "#ffffff";
        picker.style.display = "none";
        picker.onchange = () => {
          editing.colors[groupName] = picker.value;
          render();
        };
        document.body.appendChild(picker);
        picker.click();
      };
      app.appendChild(colorBtn);

      words.forEach((word, i) => {
        addEditableField(app, `◊û◊ô◊ú◊î ${i+1}`, word, v => editing.groups[groupName][i] = v);
      });

      let div = document.createElement("div");
      div.className = "divider";
      app.appendChild(div);
    }

    let btnRow = document.createElement("div");
    btnRow.className = "center";

    let next = document.createElement("button");
    next.className = "btn";
    next.innerText = "◊î◊û◊©◊ö ◊ú◊ë◊ó◊ô◊®◊™ ◊®◊û◊ñ";
    next.onclick = () => {
      stage = 'hint';
      render();
    };
    btnRow.appendChild(next);

    let back = document.createElement("button");
    back.className = "btn";
    back.innerText = "◊ó◊ñ◊ï◊®";
    back.onclick = () => {
      stage = 'menu';
      render();
    };
    btnRow.appendChild(back);

    app.appendChild(btnRow);
    return;
  }

  if (stage === 'hint') {
    let title = document.createElement("h1");
    title.innerText = "◊ë◊ó◊® ◊®◊û◊ñ (2 ◊û◊ô◊ú◊ô◊ù ◊û◊ê◊ï◊™◊î ◊ß◊ë◊ï◊¶◊î)";
    app.appendChild(title);

    let selected = [...editing.hintPair];
    let grid = document.createElement("div");
    grid.className = "grid";

    let words = Object.values(editing.groups).flat();
    words.forEach(word => {
      let div = document.createElement("div");
      div.className = "tile";
      div.innerText = word;
      if (selected.includes(word)) div.classList.add("selected");
      div.onclick = () => {
        if (selected.includes(word)) {
          selected = selected.filter(w => w !== word);
        } else if (selected.length < 2) {
          selected.push(word);
        }
        render();
      };
      grid.appendChild(div);
    });
    app.appendChild(grid);

    let btnRow = document.createElement("div");
    btnRow.className = "center";

    if (selected.length === 2 && sameGroup(selected, editing.groups)) {
      let save = document.createElement("button");
      save.className = "btn";
      save.innerText = "üíæ ◊©◊û◊ï◊® ◊©◊ú◊ë";
      save.onclick = () => {
        editing.hintPair = selected;
        editing.words = Object.values(editing.groups).flat();
        if (current === -1) levels.push(editing);
        else levels[current] = editing;
        saveToLocal();
        stage = 'menu';
        render();
      };
      btnRow.appendChild(save);
    }

    let back = document.createElement("button");
    back.className = "btn";
    back.innerText = "◊ó◊ñ◊ï◊®";
    back.onclick = () => {
      stage = 'edit';
      render();
    };
    btnRow.appendChild(back);

    app.appendChild(btnRow);
    return;
  }
}

function sameGroup(pair, groups) {
  return Object.values(groups).some(arr => arr.includes(pair[0]) && arr.includes(pair[1]));
}

function addEditableField(parent, label, value, callback) {
  let wrapper = document.createElement("div");
  wrapper.className = "field";
  wrapper.innerHTML = `<div class="field-title">${label}</div><div>${value || "‚Äî"}</div>`;
  wrapper.onclick = () => {
    document.getElementById("modalTitle").innerText = label;
    document.getElementById("modalInput").value = value;
    document.getElementById("modal").style.display = "flex";
    document.getElementById("modal").dataset.callback = callback.toString();
    document.getElementById("modal").dataset.setter = callback;
    window.currentCallback = callback;
    window.currentValue = value;
  };
  parent.appendChild(wrapper);
}

function closeModal(save) {
  document.getElementById("modal").style.display = "none";
  if (save) {
    let val = document.getElementById("modalInput").value;
    if (typeof window.currentCallback === "function") {
      window.currentCallback(val);
      render();
    }
  }
}

render();
</script>

</body>
</html>