<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ניהול שלבים - DEBUG</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #fff8dc;
      padding: 20px;
      text-align: right;
    }
    h1 { font-size: 24px; text-align: center; }
    .hidden { display: none; }
    .btn {
      background: #333; color: #fff; padding: 10px;
      border: none; border-radius: 6px; cursor: pointer; margin: 5px 0;
      width: 100%; font-size: 18px;
    }
    input, select { font-size: 18px; padding: 8px; margin-bottom: 10px; width: 100%; }
    .tile {
      padding: 10px; border: 1px solid #999; border-radius: 5px;
      cursor: pointer; margin: 5px; text-align: center;
    }
    .tile.selected { background: #cce5ff; }
    .tile.disabled { background: #eee; color: #aaa; cursor: not-allowed; }
  </style>
</head>
<body>

<div id="login">
  <h1>🔐 התחברות</h1>
  <input type="password" id="tokenInput" placeholder="הזן טוקן GitHub">
  <button class="btn" onclick="enterToken()">התחבר</button>
</div>

<div id="menu" class="hidden">
  <h1>תפריט</h1>
  <button class="btn" onclick="showLevels()">📂 עריכת שלב</button>
  <button class="btn" onclick="createLevel()">➕ יצירת שלב</button>
</div>

<div id="editor" class="hidden">
  <h1 id="editorTitle">עריכת שלב</h1>
  <input id="levelTitle" placeholder="שם השלב">
  <select id="difficulty">
    <option>קל</option><option>בינוני</option><option>קשה</option>
  </select>
  <div id="groupsContainer"></div>
  <button class="btn" onclick="selectHints()">המשך לבחירת רמז</button>
</div>

<div id="hintSection" class="hidden">
  <h1>בחר רמז (2 מילים מאותה קבוצה)</h1>
  <div id="hintGrid" style="display:grid; grid-template-columns:repeat(4,1fr); gap:8px;"></div>
  <button class="btn" onclick="copyGitPayload()">📋 העתק בקשת GitHub</button>
  <button class="btn" onclick="copyLevelJSON()">📋 העתק JSON</button>
  <button class="btn" onclick="saveLevel()" id="saveBtn" disabled>💾 שמור</button>
</div>

<script>
let token='', levels=[], sha='', editingIdx=null, currentLevel={}, selectedHint=[];

async function enterToken(){
  token=document.getElementById('tokenInput').value.trim();
  if(!token) return alert("חסר טוקן!");
  document.getElementById('login').classList.add('hidden');
  document.getElementById('menu').classList.remove('hidden');
}

async function loadLevels(){
  const res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json",{
    headers:{Authorization:`token ${token}`}
  });
  if(!res.ok) return alert("שגיאת טעינת SHA!");
  const json = await res.json();
  sha = json.sha;
  levels = JSON.parse(atob(json.content));
}

async function showLevels(){
  await loadLevels();
  const btns = levels.map((lvl,i)=>`<button class="btn" onclick="editLevel(${i})">${lvl.title}</button>`).join("");
  document.body.innerHTML += `<div id="levelList">${btns}</div>`;
  document.getElementById('menu').classList.add('hidden');
}

function editLevel(i){
  editingIdx=i;
  currentLevel=JSON.parse(JSON.stringify(levels[i]));
  selectedHint=[...currentLevel.hintPair];
  renderEditor();
}

function createLevel(){
  editingIdx=null;
  currentLevel={title:"",difficulty:"קל",words:[],groups:{},hintPair:[]};
  selectedHint=[];
  renderEditor();
}

function renderEditor(){
  document.getElementById('menu').classList.add('hidden');
  document.getElementById('editor').classList.remove('hidden');
  document.getElementById('levelTitle').value=currentLevel.title;
  document.getElementById('difficulty').value=currentLevel.difficulty;
  let html="";
  const keys=Object.keys(currentLevel.groups);
  for(let i=0;i<4;i++){
    const name=keys[i]||"";
    const words=currentLevel.groups[name]||["","","",""];
    html+=`<input id="group-name-${i}" value="${name}" placeholder="שם קבוצה ${i+1}">`;
    words.forEach((w,j)=>{
      html+=`<input id="word-${i}-${j}" value="${w}" placeholder="מילה ${j+1}">`;
    });
  }
  document.getElementById('groupsContainer').innerHTML=html;
}

function selectHints(){
  currentLevel.title=document.getElementById('levelTitle').value;
  currentLevel.difficulty=document.getElementById('difficulty').value;
  currentLevel.groups={}; currentLevel.words=[];
  for(let i=0;i<4;i++){
    const gName=document.getElementById(`group-name-${i}`).value;
    const words=[];
    for(let j=0;j<4;j++)words.push(document.getElementById(`word-${i}-${j}`).value);
    currentLevel.groups[gName]=words; currentLevel.words.push(...words);
  }
  renderHints();
}

function renderHints(){
  document.getElementById('editor').classList.add('hidden');
  document.getElementById('hintSection').classList.remove('hidden');
  document.getElementById('hintGrid').innerHTML=currentLevel.words.map(w=>{
    let dis=(selectedHint.length==1&&!currentLevel.groups[Object.keys(currentLevel.groups).find(k=>currentLevel.groups[k].includes(selectedHint[0]))].includes(w))?'disabled':'';
    let sel=selectedHint.includes(w)?'selected':'';
    return `<div class="tile ${sel} ${dis}" onclick="toggleHint('${w}')">${w}</div>`;
  }).join("");
  document.getElementById('saveBtn').disabled=selectedHint.length!=2;
}

function toggleHint(w){
  if(selectedHint.includes(w))selectedHint=selectedHint.filter(x=>x!=w);
  else if(selectedHint.length<2)selectedHint.push(w);
  renderHints();
}

function copyGitPayload(){
  const payload={message:"Update levels",content:btoa(unescape(encodeURIComponent(JSON.stringify(levels,null,2)))),sha};
  navigator.clipboard.writeText(JSON.stringify(payload,null,2));
  alert("בקשת GitHub הועתקה ללוח!");
}

function copyLevelJSON(){
  navigator.clipboard.writeText(JSON.stringify(levels,null,2));
  alert("JSON הועתק ללוח!");
}

async function saveLevel(){
  if(editingIdx!=null)levels[editingIdx]=currentLevel;
  else levels.push(currentLevel);
  const payload={
    message:"Update levels",
    content:btoa(unescape(encodeURIComponent(JSON.stringify(levels,null,2)))),sha
  };
  const res=await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json",{
    method:"PUT",headers:{Authorization:`token ${token}`,"Content-Type":"application/json"},
    body:JSON.stringify(payload)
  });
  if(res.ok)alert("✅ נשמר בהצלחה!"),location.reload();
  else alert("❌ שגיאה בשמירה: "+(await res.text()));
}
</script>
</body>
</html>