<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>עורך שלבים!</title>
  <style>
    body {
      background: #fff8dc;
      font-family: system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      text-align: right;
    }
    h1 {
      text-align: center;
      font-size: 24px;
    }
    .hidden {
      display: none;
    }
    .btn {
      background: #333;
      color: white;
      padding: 10px;
      margin: 5px 0;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      width: 100%;
    }
    input, button {
      font-size: 16px;
      padding: 8px;
      margin-top: 5px;
      width: 100%;
      box-sizing: border-box;
    }
    .level-card {
      background: white;
      padding: 10px;
      border-radius: 8px;
      margin: 10px 0;
      border: 1px solid #ccc;
    }
    .group-block {
      border-top: 1px solid #ccc;
      margin-top: 20px;
      padding-top: 10px;
    }
    .group-words input {
      width: 23%;
      margin: 1%;
      display: inline-block;
    }
    .hint-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }
    .tile {
      background: white;
      padding: 10px;
      border: 1px solid #aaa;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
    }
    .tile.selected {
      background: #cce5ff;
    }
  </style>
</head>
<body>
  <div id="login">
    <h1>🔐 התחברות</h1>
    <input id="tokenInput" placeholder="הכנס טוקן GitHub" type="password">
    <button class="btn" onclick="enter()">התחבר</button>
  </div>

  <div id="menu" class="hidden">
    <h1>בחר שלב</h1>
    <div id="levelsList"></div>
    <button class="btn" onclick="createNewLevel()">➕ צור שלב חדש</button>
  </div>

  <div id="editor" class="hidden">
    <h1 id="editorTitle">עריכת שלב</h1>
    <input id="levelTitle" placeholder="שם השלב">
    <div id="groupsContainer"></div>
    <button class="btn" onclick="goToHint()">המשך</button>
    <button class="btn" onclick="backToMenu()">חזור</button>
  </div>

  <div id="hintSelection" class="hidden">
    <h1>בחר רמז (שתי מילים מאותה קבוצה)</h1>
    <div class="hint-grid" id="hintGrid"></div>
    <button class="btn" onclick="saveLevel()" id="saveBtn" disabled>💾 שמור</button>
    <button class="btn" onclick="backToEditor()">חזור</button>
  </div>

  <script>
    let token = '';
    let levels = [];
    let sha = '';
    let editingIndex = null;
    let currentLevel = null;
    let selectedHint = [];

    const repo = "guyk217/Connections-Game";
    const filePath = "levels.json";

    function enter() {
      token = document.getElementById("tokenInput").value.trim();
      if (!token) return alert("יש להזין טוקן");
      loadLevels();
    }

    function show(id) {
      document.querySelectorAll("div").forEach(d => d.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
    }

    async function loadLevels() {
      show("menu");
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        headers: { Authorization: `token ${token}` }
      });
      const json = await res.json();
      if (!json.content) return alert("שגיאה בקריאת הקובץ");
      sha = json.sha;
      levels = JSON.parse(atob(json.content));
      renderLevelList();
    }

    function renderLevelList() {
      const container = document.getElementById("levelsList");
      container.innerHTML = "";
      levels.forEach((lvl, i) => {
        const div = document.createElement("div");
        div.className = "level-card";
        div.innerHTML = `
          <strong>${lvl.title}</strong><br>
          <button class="btn" onclick="editLevel(${i})">✏️ ערוך</button>
          <button class="btn" onclick="confirmDelete(${i})">🗑️ מחק</button>
        `;
        container.appendChild(div);
      });
    }

    function confirmDelete(i) {
      if (!confirm(`האם למחוק את "${levels[i].title}"?`)) return;
      levels.splice(i, 1);
      saveToGitHub();
    }

    function createNewLevel() {
      editingIndex = null;
      currentLevel = {
        title: "",
        words: [],
        groups: {},
        colors: {},
        hintPair: []
      };
      renderEditor();
    }

    function editLevel(i) {
      editingIndex = i;
      currentLevel = JSON.parse(JSON.stringify(levels[i]));
      renderEditor();
    }

    function renderEditor() {
      show("editor");
      document.getElementById("editorTitle").innerText = editingIndex === null ? "שלב חדש" : "עריכת שלב";
      document.getElementById("levelTitle").value = currentLevel.title;
      const container = document.getElementById("groupsContainer");
      container.innerHTML = "";
      const groupNames = Object.keys(currentLevel.groups);
      for (let i = 0; i < 4; i++) {
        const name = groupNames[i] || "";
        const words = currentLevel.groups[name] || ["", "", "", ""];
        const block = document.createElement("div");
        block.className = "group-block";
        block.innerHTML = `
          <input placeholder="שם קבוצה" id="group-name-${i}" value="${name}">
          <div class="group-words">
            ${words.map((w, j) => `<input id="word-${i}-${j}" value="${w}" placeholder="מילה ${j+1}">`).join('')}
          </div>
        `;
        container.appendChild(block);
      }
    }

    function goToHint() {
      const title = document.getElementById("levelTitle").value.trim();
      if (!title) return alert("יש להזין שם שלב");

      let allWords = [];
      let groups = {};
      for (let i = 0; i < 4; i++) {
        const name = document.getElementById(`group-name-${i}`).value.trim() || `קבוצה ${i+1}`;
        const words = [];
        for (let j = 0; j < 4; j++) {
          const word = document.getElementById(`word-${i}-${j}`).value.trim();
          if (!word) return alert("יש למלא את כל המילים");
          words.push(word);
        }
        groups[name] = words;
        allWords.push(...words);
      }

      currentLevel.title = title;
      currentLevel.groups = groups;
      currentLevel.words = allWords;

      selectedHint = [...(currentLevel.hintPair || [])];
      renderHintGrid();
      show("hintSelection");
    }

    function renderHintGrid() {
      const grid = document.getElementById("hintGrid");
      grid.innerHTML = "";
      currentLevel.words.forEach(word => {
        const div = document.createElement("div");
        div.className = "tile";
        div.textContent = word;
        if (selectedHint.includes(word)) div.classList.add("selected");
        div.onclick = () => {
          if (selectedHint.includes(word)) {
            selectedHint = selectedHint.filter(w => w !== word);
          } else if (selectedHint.length < 2) {
            selectedHint.push(word);
          }
          validateHint();
          renderHintGrid();
        };
        grid.appendChild(div);
      });
      validateHint();
    }

    function validateHint() {
      const btn = document.getElementById("saveBtn");
      if (selectedHint.length !== 2) return btn.disabled = true;
      const groups = Object.values(currentLevel.groups);
      const isValid = groups.some(g => g.includes(selectedHint[0]) && g.includes(selectedHint[1]));
      btn.disabled = !isValid;
    }

    function backToEditor() {
      show("editor");
    }

    function backToMenu() {
      show("menu");
    }

    async function saveLevel() {
      currentLevel.hintPair = selectedHint;
      if (editingIndex === null) levels.push(currentLevel);
      else levels[editingIndex] = currentLevel;
      await saveToGitHub();
    }

    async function saveToGitHub() {
      const content = btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2))));
      await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          Authorization: `token ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Update levels.json",
          content: content,
          sha: sha
        })
      });
      alert("נשמר בהצלחה!");
      location.reload();
    }
  </script>
</body>
</html>