<!DOCTYPE html>
<html dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>× ×™×”×•×œ ×©×œ×‘×™×</title>
  <style>
    body {
      background: #fff8dc;
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
    }
    h1 {
      font-size: 28px;
      margin-bottom: 20px;
    }
    input, button {
      padding: 10px;
      font-size: 16px;
      margin: 5px 0;
      width: 90%;
      max-width: 300px;
    }
    .level {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px auto;
      max-width: 350px;
      background: white;
    }
    .group {
      border-top: 1px solid #aaa;
      margin-top: 10px;
      padding-top: 10px;
    }
    .word {
      display: inline-block;
      border: 1px solid #888;
      margin: 4px;
      padding: 6px 10px;
      border-radius: 5px;
      background: #f0f0f0;
    }
    .hint-select .word {
      cursor: pointer;
    }
    .word.selected {
      background: #add8e6;
    }
  </style>
</head>
<body>
  <div id="login">
    <h1>ğŸ” ×”×ª×—×‘×¨×•×ª</h1>
    <input id="token" placeholder="×”×›× ×¡ ××ª ×˜×•×§×Ÿ ×”Ö¾Git ×©×œ×š" />
    <button onclick="loadLevels()">×”××©×š</button>
  </div>

  <div id="levels" style="display:none">
    <h1>×‘×—×¨ ×©×œ×‘ ×œ×¢×¨×™×›×”</h1>
    <div id="levelList"></div>
    <button onclick="newLevel()">â• ×©×œ×‘ ×—×“×©</button>
  </div>

  <div id="editor" style="display:none"></div>
  <div id="hintPicker" style="display:none"></div>

  <script>
    let token = "";
    const repo = "guyk217/Connections-Game";
    const filePath = "levels.json";
    let sha = "";
    let currentLevels = [];
    let editingIndex = -1;
    let selectedHint = [];

    function loadLevels() {
      token = document.getElementById("token").value.trim();
      if (!token) return alert("× × ×œ×”×–×™×Ÿ ×˜×•×§×Ÿ");

      fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        headers: { Authorization: `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        sha = data.sha;
        const content = atob(data.content);
        const levels = JSON.parse(content);
        currentLevels = levels; // âœ… ×—×©×•×‘!
        showLevelList(levels);
      })
      .catch(() => alert("×©×’×™××” ×‘×’×™×©×” ×œ×§×•×‘×¥"));
    }

    function showLevelList(levels) {
      document.getElementById("login").style.display = "none";
      document.getElementById("levels").style.display = "block";

      const list = document.getElementById("levelList");
      list.innerHTML = "";

      levels.forEach((lvl, i) => {
        const div = document.createElement("div");
        div.className = "level";
        div.innerHTML = `
          <b>${lvl.title}</b><br/>
          <button onclick="editLevel(${i})">×¢×¨×•×š</button>
          <button onclick="deleteLevel(${i})">××—×§</button>
        `;
        list.appendChild(div);
      });
    }

    function newLevel() {
      const title = prompt("×©× ×”×©×œ×‘:");
      if (!title) return;
      const newLvl = {
        title,
        words: [],
        groups: [
          { name: "×§×‘×•×¦×” 1", words: [], color: "" },
          { name: "×§×‘×•×¦×” 2", words: [], color: "" },
          { name: "×§×‘×•×¦×” 3", words: [], color: "" },
          { name: "×§×‘×•×¦×” 4", words: [], color: "" }
        ],
        hintPair: []
      };
      currentLevels.push(newLvl);
      editingIndex = currentLevels.length - 1;
      showEditor();
    }

    function editLevel(i) {
      editingIndex = i;
      selectedHint = currentLevels[i].hintPair || [];
      showEditor();
    }

    function showEditor() {
      document.getElementById("levels").style.display = "none";
      const level = currentLevels[editingIndex];
      const ed = document.getElementById("editor");
      ed.innerHTML = `<h1>${level.title}</h1>`;

      level.groups.forEach((grp, gi) => {
        ed.innerHTML += `
          <div class="group">
            <b>${grp.name}</b><br/>
            ${grp.words.map((w, wi) => `<input value="${w}" onchange="updateWord(${gi},${wi},this.value)" />`).join("")}<br/>
            <label>×¦×‘×¢:</label><input value="${grp.color}" onchange="updateColor(${gi},this.value)" />
          </div>
        `;
      });

      ed.innerHTML += `
        <button onclick="goHintPicker()">×”××©×š</button>
        <button onclick="backToList()">×—×–×•×¨</button>
      `;
      ed.style.display = "block";
      document.getElementById("hintPicker").style.display = "none";
    }

    function updateWord(gi, wi, val) {
      currentLevels[editingIndex].groups[gi].words[wi] = val;
    }

    function updateColor(gi, val) {
      currentLevels[editingIndex].groups[gi].color = val;
    }

    function backToList() {
      document.getElementById("editor").style.display = "none";
      document.getElementById("levels").style.display = "block";
    }

    function goHintPicker() {
      const level = currentLevels[editingIndex];
      const allWords = level.groups.flatMap(g => g.words);
      if (allWords.length < 16) {
        alert("×¦×¨×™×š 16 ××™×œ×™× ×œ×¤×—×•×ª");
        return;
      }
      const grid = document.getElementById("hintPicker");
      grid.innerHTML = `<h1>×‘×—×¨ 2 ××™×œ×™× ×œ×¨××–</h1>`;
      grid.className = "hint-select";
      allWords.forEach(w => {
        const span = document.createElement("div");
        span.className = "word";
        span.innerText = w;
        if (selectedHint.includes(w)) span.classList.add("selected");
        span.onclick = () => toggleHintWord(w, span);
        grid.appendChild(span);
      });
      grid.innerHTML += `<br/><button onclick="saveLevel()">×©××•×¨</button>`;
      document.getElementById("editor").style.display = "none";
      grid.style.display = "block";
    }

    function toggleHintWord(word, el) {
      if (selectedHint.includes(word)) {
        selectedHint = selectedHint.filter(w => w !== word);
        el.classList.remove("selected");
      } else {
        if (selectedHint.length === 2) return;
        selectedHint.push(word);
        el.classList.add("selected");
      }
    }

    function saveLevel() {
      if (selectedHint.length !== 2) return alert("×‘×—×¨ 2 ××™×œ×™× ×œ×¨××–");
      currentLevels[editingIndex].hintPair = selectedHint;
      updateFile();
    }

    function deleteLevel(i) {
      if (!confirm("×”×× ×œ××—×•×§ ××ª ×”×©×œ×‘?")) return;
      currentLevels.splice(i, 1);
      updateFile();
    }

    function updateFile() {
      const content = btoa(JSON.stringify(currentLevels, null, 2));
      fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        method: "PUT",
        headers: {
          Authorization: `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "×¢×“×›×•×Ÿ ×©×œ×‘×™×",
          content,
          sha
        })
      })
      .then(res => res.json())
      .then(() => location.reload())
      .catch(() => alert("×©×’×™××” ×‘×©××™×¨×”"));
    }
  </script>
</body>
</html>