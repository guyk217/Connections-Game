<!-- editor.html -->
<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>עורך שלבים</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 20px;
      direction: rtl;
    }
    h1 {
      text-align: center;
      font-size: 26px;
    }
    .section {
      margin-bottom: 25px;
      background: white;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .field-label {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .editable {
      padding: 8px 12px;
      background: #eee;
      border-radius: 6px;
      cursor: pointer;
      margin-bottom: 10px;
    }
    .group {
      border-top: 1px solid #ccc;
      margin-top: 20px;
      padding-top: 10px;
    }
    .color-btn {
      margin-right: 10px;
      padding: 6px 12px;
      border: none;
      border-radius: 5px;
      background: #ddd;
      cursor: pointer;
    }
    .hint-tile {
      display: inline-block;
      padding: 10px;
      margin: 6px;
      border-radius: 6px;
      background: white;
      border: 1px solid #999;
      cursor: pointer;
    }
    .hint-tile.selected {
      background: #ccc;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 18px;
      border-radius: 8px;
      border: none;
      background: #333;
      color: white;
      cursor: pointer;
      display: block;
      margin-inline: auto;
    }
    #login-screen, #menu-screen, #edit-screen, #hint-screen {
      display: none;
    }
    .visible {
      display: block;
    }
  </style>
</head>
<body>

<div id="login-screen" class="visible">
  <h1>🔐 התחברות</h1>
  <div style="text-align:center">
    <p>הכנס את טוקן ה־Git שלך לצורך הזדהות</p>
    <input id="token-input" placeholder="הדבק כאן את הטוקן שלך" style="width: 90%; padding: 10px; font-size: 16px; border-radius: 8px; border: 1px solid #ccc; direction: ltr;" />
    <br /><br />
    <button onclick="login()">התחברות</button>
  </div>
</div>

<div id="menu-screen">
  <h1>📋 ניהול שלבים</h1>
  <div id="level-list"></div>
  <button onclick="createNewLevel()">➕ צור שלב חדש</button>
</div>

<div id="edit-screen"></div>

<div id="hint-screen">
  <h1>💡 בחר רמז</h1>
  <p style="text-align:center;">בחר שתי מילים מאותה קבוצה</p>
  <div id="hint-tiles" style="text-align: center;"></div>
  <button onclick="saveLevel()">💾 שמור שלב</button>
</div>

<input type="color" id="color-picker" style="display:none;" onchange="applyColor(event)" />

<script>
let token = '';
let levels = [];
let currentIndex = null;
let currentLevel = null;
let selectedHint = [];

const loginScreen = document.getElementById("login-screen");
const menuScreen = document.getElementById("menu-screen");
const editScreen = document.getElementById("edit-screen");
const hintScreen = document.getElementById("hint-screen");

function show(id) {
  loginScreen.classList.remove("visible");
  menuScreen.classList.remove("visible");
  editScreen.classList.remove("visible");
  hintScreen.classList.remove("visible");
  document.getElementById(id).classList.add("visible");
}

async function login() {
  token = document.getElementById("token-input").value.trim();
  if (!token) return alert("יש להזין טוקן");

  let res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
    headers: { Authorization: `token ${token}` }
  });
  let data = await res.json();
  if (!data.content) return alert("לא הצלחנו לטעון שלבים");

  levels = JSON.parse(atob(data.content));
  show("menu-screen");
  renderMenu();
}

function renderMenu() {
  const list = document.getElementById("level-list");
  list.innerHTML = "";
  levels.forEach((lvl, idx) => {
    const div = document.createElement("div");
    div.className = "section";
    div.innerHTML = `
      <div><strong>${lvl.title}</strong></div>
      <button onclick="editLevel(${idx})">✏️ ערוך</button>
      <button onclick="deleteLevel(${idx})" style="background:#a33;">🗑️ מחק</button>
    `;
    list.appendChild(div);
  });
}

function deleteLevel(idx) {
  if (!confirm("האם למחוק שלב זה?")) return;
  levels.splice(idx, 1);
  uploadLevels();
  renderMenu();
}

function createNewLevel() {
  const defaultGroups = {
    "קבוצה 1": ["", "", "", ""],
    "קבוצה 2": ["", "", "", ""],
    "קבוצה 3": ["", "", "", ""],
    "קבוצה 4": ["", "", "", ""]
  };
  const defaultColors = {
    "קבוצה 1": "",
    "קבוצה 2": "",
    "קבוצה 3": "",
    "קבוצה 4": ""
  };
  currentLevel = {
    title: "שלב חדש",
    groups: defaultGroups,
    colors: defaultColors,
    words: [],
    hintPair: []
  };
  currentIndex = levels.length;
  editLevelInternal();
}

function editLevel(idx) {
  currentIndex = idx;
  currentLevel = JSON.parse(JSON.stringify(levels[idx]));
  editLevelInternal();
}

function editLevelInternal() {
  show("edit-screen");
  editScreen.innerHTML = "";

  const section = document.createElement("div");
  section.className = "section";

  const title = createEditable("שם השלב", currentLevel.title, val => currentLevel.title = val);
  section.appendChild(title);

  Object.entries(currentLevel.groups).forEach(([group, words], index) => {
    const g = document.createElement("div");
    g.className = "group";
    const label = createEditable(`שם קבוצה ${index + 1}`, group, newGroup => {
      if (newGroup === group) return;
      currentLevel.groups[newGroup] = currentLevel.groups[group];
      if (currentLevel.colors[group]) {
        currentLevel.colors[newGroup] = currentLevel.colors[group];
        delete currentLevel.colors[group];
      }
      delete currentLevel.groups[group];
      editLevelInternal();
    });
    g.appendChild(label);

    words.forEach((word, wi) => {
      const w = createEditable(`מילה ${wi + 1}`, word, newWord => {
        currentLevel.groups[group][wi] = newWord;
      });
      g.appendChild(w);
    });

    const colorBtn = document.createElement("button");
    colorBtn.innerText = "בחר צבע (לא חובה)";
    colorBtn.className = "color-btn";
    colorBtn.onclick = () => {
      window._currentColorGroup = group;
      document.getElementById("color-picker").click();
    };
    g.appendChild(colorBtn);

    section.appendChild(g);
  });

  editScreen.appendChild(section);

  const next = document.createElement("button");
  next.innerText = "המשך";
  next.onclick = () => goToHintSelection();
  editScreen.appendChild(next);

  const back = document.createElement("button");
  back.innerText = "חזור";
  back.style.background = "#888";
  back.onclick = () => show("menu-screen");
  editScreen.appendChild(back);
}

function createEditable(label, value, setter) {
  const div = document.createElement("div");
  const lab = document.createElement("div");
  lab.className = "field-label";
  lab.innerText = label;
  const val = document.createElement("div");
  val.className = "editable";
  val.innerText = value || "—";
  val.onclick = async () => {
    const input = prompt(label, val.innerText);
    if (input !== null) {
      val.innerText = input;
      setter(input);
    }
  };
  div.appendChild(lab);
  div.appendChild(val);
  return div;
}

function applyColor(e) {
  const color = e.target.value;
  const group = window._currentColorGroup;
  if (group) currentLevel.colors[group] = color;
}

function goToHintSelection() {
  selectedHint = currentLevel.hintPair || [];
  show("hint-screen");

  const container = document.getElementById("hint-tiles");
  container.innerHTML = "";
  const all = Object.values(currentLevel.groups).flat();

  all.forEach(word => {
    const tile = document.createElement("div");
    tile.className = "hint-tile";
    tile.innerText = word;
    if (selectedHint.includes(word)) tile.classList.add("selected");
    tile.onclick = () => {
      if (selectedHint.includes(word)) {
        selectedHint = selectedHint.filter(w => w !== word);
      } else {
        if (selectedHint.length < 2) selectedHint.push(word);
      }
      goToHintSelection();
    };
    container.appendChild(tile);
  });
}

function saveLevel() {
  if (selectedHint.length !== 2) {
    alert("יש לבחור שתי מילים לרמז.");
    return;
  }

  const sameGroup = Object.values(currentLevel.groups).some(group =>
    group.includes(selectedHint[0]) && group.includes(selectedHint[1])
  );
  if (!sameGroup) {
    alert("שתי המילים חייבות להיות מאותה קבוצה.");
    return;
  }

  currentLevel.hintPair = selectedHint;
  currentLevel.words = Object.values(currentLevel.groups).flat();
  levels[currentIndex] = currentLevel;
  uploadLevels();
  show("menu-screen");
  renderMenu();
}

async function uploadLevels() {
  const res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
    method: "GET",
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  const sha = data.sha;

  await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
    method: "PUT",
    headers: { Authorization: `token ${token}` },
    body: JSON.stringify({
      message: "update levels",
      content: btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2)))),
      sha: sha
    })
  });
}
</script>
</body>
</html>