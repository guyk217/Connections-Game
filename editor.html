<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>עורך שלבים</title>
  <style>
    body {
      background: #fff8dc;
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
    }
    h2 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      background: #333;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
    }
    input, select {
      font-size: 16px;
      margin: 5px auto;
      padding: 8px;
      width: 90%;
      display: block;
    }
    .group-box {
      border-top: 1px solid #ccc;
      margin-top: 20px;
      padding-top: 10px;
    }
    .word-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      margin-bottom: 10px;
    }
    .word-row input {
      width: 22%;
      margin: 1%;
    }
    .level-box {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
    }
    .hint-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .hint-word {
      padding: 10px;
      background: #eee;
      border-radius: 5px;
      cursor: pointer;
    }
    .hint-word.selected {
      background: #88f;
      color: white;
    }
  </style>
</head>
<body>

<div id="app">
  <h2>🔐 התחברות</h2>
  <p>הכנס את טוקן ה-Git שלך לצורך הזדהות</p>
  <input id="token" placeholder="github_pat_..." />
  <button onclick="loadLevels()">התחבר</button>
</div>

<script>
const repo = "guyk217/Connections-Game";
const filePath = "levels.json";
let sha = "";
let token = "";

function ui(html) {
  document.getElementById("app").innerHTML = html;
}

async function loadLevels() {
  token = document.getElementById("token").value.trim();
  if (!token) return alert("נא להזין טוקן");

  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
    headers: { Authorization: `Bearer ${token}` }
  });

  if (!res.ok) return alert("שגיאה בהתחברות או בגישה לקובץ");

  const data = await res.json();
  sha = data.sha;
  const content = atob(data.content);
  try {
    const levels = JSON.parse(content);
    showLevelList(levels);
  } catch {
    alert("פורמט קובץ שגוי");
  }
}

function showLevelList(levels) {
  let html = `<h2>בחר שלב לעריכה</h2>`;
  levels.forEach((lvl, i) => {
    html += `
      <div class="level-box">
        <b>${lvl.title}</b><br/>
        <button onclick="editLevel(${i})">✏️ ערוך</button>
        <button onclick="deleteLevel(${i})">🗑️ מחק</button>
      </div>`;
  });
  html += `<button onclick="newLevel()">➕ צור שלב חדש</button>`;
  html += `<button onclick="location.reload()">חזור</button>`;
  ui(html);
}

let currentLevels = [];
let editingIndex = null;
let tempLevel = null;

function newLevel() {
  editingIndex = null;
  tempLevel = {
    title: "",
    words: [],
    groups: [],
    colors: [],
    hintPair: []
  };
  editForm();
}

function editLevel(i) {
  editingIndex = i;
  tempLevel = JSON.parse(JSON.stringify(currentLevels[i]));
  editForm();
}

function editForm() {
  let html = `<h2>${editingIndex === null ? "שלב חדש" : "עריכת שלב"}</h2>`;
  html += `<input id="levelTitle" placeholder="שם השלב" value="${tempLevel.title}" />`;

  for (let g = 0; g < 4; g++) {
    const group = tempLevel.groups[g] || [];
    const color = tempLevel.colors[g] || "";
    html += `<div class="group-box">
      <input placeholder="שם קבוצה" value="${group[0] || ""}" id="g${g}name" />
      <div class="word-row">`;
    for (let w = 1; w <= 4; w++) {
      html += `<input placeholder="מילה ${w}" value="${group[w] || ""}" id="g${g}w${w}" />`;
    }
    html += `</div><input placeholder="צבע (לא חובה)" value="${color}" id="g${g}color" /></div>`;
  }

  html += `<button onclick="goToHint()">המשך</button>`;
  html += `<button onclick="loadLevels()">חזור</button>`;
  ui(html);
}

function goToHint() {
  tempLevel.title = document.getElementById("levelTitle").value.trim();
  tempLevel.groups = [];
  tempLevel.words = [];
  tempLevel.colors = [];

  for (let g = 0; g < 4; g++) {
    const name = document.getElementById(`g${g}name`).value.trim();
    const words = [];
    for (let w = 1; w <= 4; w++) {
      words.push(document.getElementById(`g${g}w${w}`).value.trim());
    }
    tempLevel.groups.push([name, ...words]);
    tempLevel.words.push(...words);
    tempLevel.colors.push(document.getElementById(`g${g}color`).value.trim());
  }

  let html = `<h2>בחר רמז (2 מילים מאותה קבוצה)</h2>`;
  html += `<div class="hint-grid">`;
  tempLevel.words.forEach(word => {
    html += `<div class="hint-word" onclick="selectHint(this, '${word}')">${word}</div>`;
  });
  html += `</div>`;
  html += `<button onclick="saveLevel()">שמור</button>`;
  html += `<button onclick="editForm()">חזור</button>`;
  ui(html);
}

let hintSelected = [];

function selectHint(el, word) {
  if (hintSelected.includes(word)) {
    hintSelected = hintSelected.filter(w => w !== word);
    el.classList.remove("selected");
  } else {
    if (hintSelected.length === 2) {
      document.querySelectorAll(".hint-word.selected").forEach(e => e.classList.remove("selected"));
      hintSelected = [];
    }
    hintSelected.push(word);
    el.classList.add("selected");
  }
}

async function saveLevel() {
  if (hintSelected.length !== 2) return alert("בחר שתי מילים לרמז");

  tempLevel.hintPair = [...hintSelected];
  if (editingIndex === null) {
    currentLevels.push(tempLevel);
  } else {
    currentLevels[editingIndex] = tempLevel;
  }

  await updateFile();
}

async function deleteLevel(i) {
  if (!confirm("האם אתה בטוח שברצונך למחוק שלב זה?")) return;
  currentLevels.splice(i, 1);
  await updateFile();
}

async function updateFile() {
  const content = btoa(JSON.stringify(currentLevels, null, 2));
  const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
    method: "PUT",
    headers: {
      Authorization: `Bearer ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "עדכון שלבים",
      content,
      sha
    })
  });

  if (res.ok) {
    alert("✅ נשמר בהצלחה!");
    location.reload();
  } else {
    alert("❌ שגיאה בשמירה");
  }
}
</script>
</body>
</html>