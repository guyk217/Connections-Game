<!-- ×©××•×¨ ×§×•×‘×¥ ×–×” ×‘×©× editor.html -->
<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>×¢×•×¨×š ×©×œ×‘×™×</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
      background: #f8f8f8;
      direction: rtl;
      text-align: right;
    }
    .screen {
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }
    h1 {
      font-size: 24px;
      text-align: center;
    }
    input, button, select {
      font-size: 16px;
      padding: 10px;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #333;
      color: white;
      cursor: pointer;
    }
    .level-box {
      background: white;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    .inline-inputs {
      display: flex;
      gap: 6px;
    }
    .inline-inputs input {
      flex: 1;
    }
    .group-divider {
      border-top: 1px solid #ddd;
      margin: 20px 0 10px;
    }
    .color-button {
      padding: 6px;
      border: 1px solid #aaa;
      border-radius: 6px;
      background: #eee;
      cursor: pointer;
    }
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 90%;
      max-width: 400px;
    }
    .tile-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    .tile {
      padding: 10px;
      background: #fff;
      border: 1px solid #aaa;
      border-radius: 5px;
      text-align: center;
      cursor: pointer;
    }
    .tile.selected {
      background: #d0f0d0;
      border-color: green;
    }
  </style>
</head>
<body>
  <div id="app" class="screen"></div>

  <script>
    let token = '';
    let repo = 'guyk217/Connections-Game';
    let filePath = 'levels.json';
    let levels = [];
    let editingIndex = -1;
    let stage = 'login'; // login â†’ menu â†’ form â†’ hint

    const app = document.getElementById('app');

    function render() {
      app.innerHTML = '';
      if (stage === 'login') return renderLogin();
      if (stage === 'menu') return renderMenu();
      if (stage === 'form') return renderForm();
      if (stage === 'hint') return renderHintSelector();
    }

    function renderLogin() {
      const html = `
        <h1>ğŸ” ×”×ª×—×‘×¨×•×ª ×¢× ×˜×•×§×Ÿ Git</h1>
        <p>×”×›× ×¡ ××ª ×˜×•×§×Ÿ ×”-Git ×©×œ×š ×œ×¦×•×¨×š ×”×–×“×”×•×ª:</p>
        <input type="password" id="tokenInput" placeholder="github_pat_..." />
        <button onclick="handleLogin()">×”×ª×—×‘×¨</button>
      `;
      app.innerHTML = html;
    }

    async function handleLogin() {
      token = document.getElementById('tokenInput').value.trim();
      if (!token) return alert('×™×© ×œ×”×–×™×Ÿ ×˜×•×§×Ÿ');
      try {
        const content = await fetchFromGitHub();
        levels = JSON.parse(content);
        stage = 'menu';
        render();
      } catch (e) {
        alert('×”×˜×•×§×Ÿ ×©×’×•×™ ××• ×©××™×Ÿ ×’×™×©×” ×œ×§×•×‘×¥');
      }
    }

    function renderMenu() {
      let html = `<h1>×‘×—×¨ ×©×œ×‘ ×œ×¢×¨×™×›×” ××• ××—×™×§×”</h1>`;
      levels.forEach((lvl, idx) => {
        html += `
          <div class="level-box">
            <strong>${lvl.title}</strong><br/>
            <button onclick="editLevel(${idx})">×¢×¨×•×š</button>
            <button onclick="deleteLevel(${idx})">××—×§</button>
          </div>
        `;
      });
      html += `<hr/><button onclick="createNewLevel()">â• ×©×œ×‘ ×—×“×©</button>`;
      app.innerHTML = html;
    }

    function editLevel(idx) {
      editingIndex = idx;
      stage = 'form';
      render();
    }

    function deleteLevel(idx) {
      if (!confirm(`×œ××—×•×§ ××ª ×”×©×œ×‘ "${levels[idx].title}"?`)) return;
      levels.splice(idx, 1);
      saveToGitHub().then(() => {
        alert('× ××—×§');
        render();
      });
    }

    function createNewLevel() {
      const empty = {
        title: '',
        words: [],
        groups: {
          '×§×‘×•×¦×” 1': ['', '', '', ''],
          '×§×‘×•×¦×” 2': ['', '', '', ''],
          '×§×‘×•×¦×” 3': ['', '', '', ''],
          '×§×‘×•×¦×” 4': ['', '', '', '']
        },
        colors: {},
        hintPair: []
      };
      levels.push(empty);
      editingIndex = levels.length - 1;
      stage = 'form';
      render();
    }

    function renderForm() {
      const lvl = levels[editingIndex];
      let html = `<h1>×¢×¨×™×›×ª ×©×œ×‘</h1>`;
      html += `<input value="${lvl.title}" placeholder="×©× ×©×œ×‘" onchange="updateTitle(this.value)" /><br/>`;

      let i = 1;
      for (let group in lvl.groups) {
        html += `<div class="group-divider"></div>`;
        html += `<input value="${group}" onchange="renameGroup('${group}', this.value)" /><br/>`;
        html += `<div class="inline-inputs">`;
        lvl.groups[group].forEach((w, wi) => {
          html += `<input value="${w}" onchange="updateWord('${group}', ${wi}, this.value)" />`;
        });
        html += `</div>`;
        html += `<button class="color-button" onclick="openColorPicker('${group}')">×‘×—×¨ ×¦×‘×¢ (×œ× ×—×•×‘×”)</button>`;
      }

      html += `<button onclick="goToHint()">×”××©×š</button>`;
      html += `<button onclick="stage='menu';render()">×—×–×•×¨</button>`;
      app.innerHTML = html;
    }

    function updateTitle(val) {
      levels[editingIndex].title = val;
    }

    function renameGroup(oldName, newName) {
      const lvl = levels[editingIndex];
      lvl.groups[newName] = lvl.groups[oldName];
      delete lvl.groups[oldName];
      if (lvl.colors[oldName]) {
        lvl.colors[newName] = lvl.colors[oldName];
        delete lvl.colors[oldName];
      }
      render();
    }

    function updateWord(group, idx, val) {
      levels[editingIndex].groups[group][idx] = val;
    }

    function openColorPicker(group) {
      const picker = document.createElement('input');
      picker.type = 'color';
      picker.style.display = 'none';
      picker.addEventListener('input', (e) => {
        levels[editingIndex].colors[group] = e.target.value;
      });
      document.body.appendChild(picker);
      picker.click();
    }

    function goToHint() {
      stage = 'hint';
      render();
    }

    function renderHintSelector() {
      const lvl = levels[editingIndex];
      lvl.words = Object.values(lvl.groups).flat();
      const currentHint = lvl.hintPair || [];

      let html = `<h1>×‘×—×¨ ×¨××– (2 ××™×œ×™× ×××•×ª×” ×§×‘×•×¦×” ×‘×œ×‘×“)</h1>`;
      html += `<div class="tile-grid">`;
      lvl.words.forEach(word => {
        const isSelected = currentHint.includes(word);
        html += `<div class="tile ${isSelected ? 'selected' : ''}" onclick="toggleHint('${word}')">${word}</div>`;
      });
      html += `</div>`;
      html += `<button onclick="saveLevel()">ğŸ’¾ ×©××•×¨</button>`;
      html += `<button onclick="stage='form';render()">×—×–×•×¨</button>`;
      app.innerHTML = html;
    }

    function toggleHint(word) {
      const lvl = levels[editingIndex];
      let current = lvl.hintPair || [];
      if (current.includes(word)) {
        lvl.hintPair = current.filter(w => w !== word);
      } else if (current.length < 2) {
        lvl.hintPair.push(word);
      }
      render();
    }

    async function saveLevel() {
      const lvl = levels[editingIndex];
      lvl.words = Object.values(lvl.groups).flat();

      // Validate hint is from same group
      if (!lvl.hintPair || lvl.hintPair.length !== 2) {
        alert('×™×© ×œ×‘×—×•×¨ ×¨××– â€“ ×©×ª×™ ××™×œ×™× ×××•×ª×” ×§×‘×•×¦×”');
        return;
      }
      const validGroup = Object.values(lvl.groups).some(g =>
        g.includes(lvl.hintPair[0]) && g.includes(lvl.hintPair[1])
      );
      if (!validGroup) {
        alert('×”×¨××– ×—×™×™×‘ ×œ×”×™×•×ª ××ª×•×š ××•×ª×” ×§×‘×•×¦×”');
        return;
      }

      await saveToGitHub();
      alert('× ×©××¨!');
      stage = 'menu';
      render();
    }

    async function fetchFromGitHub() {
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        headers: { Authorization: 'Bearer ' + token }
      });
      const json = await res.json();
      window._sha = json.sha;
      return atob(json.content);
    }

    async function saveToGitHub() {
      const content = btoa(JSON.stringify(levels, null, 2));
      const body = {
        message: 'update levels.json',
        content,
        sha: window._sha
      };
      const res = await fetch(`https://api.github.com/repos/${repo}/contents/${filePath}`, {
        method: 'PUT',
        headers: {
          Authorization: 'Bearer ' + token,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(body)
      });
      const json = await res.json();
      window._sha = json.content?.sha || window._sha;
    }

    render();
  </script>
</body>
</html>