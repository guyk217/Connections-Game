<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ניהול שלבים</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      direction: rtl;
      text-align: right;
      padding: 20px;
      background: #f2f2f2;
    }
    h2, h3 {
      margin-top: 20px;
    }
    input, select, button, textarea {
      display: block;
      margin: 5px 0 15px;
      padding: 8px;
      width: 100%;
      box-sizing: border-box;
      direction: rtl;
      text-align: right;
      font-family: inherit;
    }
    .group {
      border-top: 1px solid #ccc;
      padding-top: 10px;
      margin-top: 10px;
    }
    .group-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    .color-btn {
      width: auto;
      display: inline-block;
      margin-bottom: 15px;
    }
    .modal {
      position: fixed;
      top: 0; right: 0; bottom: 0; left: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      max-width: 300px;
      text-align: center;
    }
    .hint-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 20px;
    }
    .hint-tile {
      background: #fff;
      border: 1px solid #aaa;
      padding: 10px;
      border-radius: 6px;
      cursor: pointer;
    }
    .hint-tile.selected {
      background: #cce5ff;
    }
  </style>
</head>
<body>

<h2>התחברות עם טוקן</h2>
<input id="tokenInput" placeholder="הכנס טוקן GitHub שלך">
<button onclick="loadLevels()">המשך</button>

<div id="app" style="display:none;"></div>

<div id="colorModal" class="modal" style="display:none;">
  <div class="modal-content">
    <h3>בחר צבע</h3>
    <input type="color" id="colorPicker">
    <br />
    <button onclick="applyColor()">אישור</button>
    <button onclick="closeColorModal()">ביטול</button>
  </div>
</div>

<script>
let token = '';
let levels = [];
let editingLevel = null;
let editingIndex = -1;
let tempColorGroup = '';
let hintSelected = [];

async function loadLevels() {
  token = document.getElementById('tokenInput').value.trim();
  if (!token) return alert('יש להזין טוקן');
  const res = await fetch('https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json', {
    headers: { Authorization: 'token ' + token }
  });
  const json = await res.json();
  const content = atob(json.content);
  levels = JSON.parse(content);
  showLevelMenu();
}

function showLevelMenu() {
  document.body.innerHTML = `
    <h2>בחר שלב לעריכה או מחיקה</h2>
    ${levels.map((lvl, i) => `
      <div>
        <b>${lvl.title}</b>
        <button onclick="editLevel(${i})">ערוך</button>
        <button onclick="deleteLevel(${i})">מחק</button>
      </div>
    `).join('')}
    <br>
    <button onclick="createNewLevel()">➕ צור שלב חדש</button>
  `;
}

function createNewLevel() {
  editingLevel = {
    title: "",
    groups: {
      "": ["", "", "", ""],
      "": ["", "", "", ""],
      "": ["", "", "", ""],
      "": ["", "", "", ""]
    },
    colors: {},
    hintPair: []
  };
  editingIndex = -1;
  renderEditor();
}

function editLevel(index) {
  editingLevel = JSON.parse(JSON.stringify(levels[index]));
  editingIndex = index;
  renderEditor();
}

function renderEditor() {
  document.body.innerHTML = `<h2>עריכת שלב</h2>
    <label>שם השלב:</label>
    <input value="${editingLevel.title}" onchange="editingLevel.title=this.value">
    ${Object.entries(editingLevel.groups).map(([group, words], i) => `
      <div class="group">
        <div class="group-title">קבוצה ${i+1}</div>
        <label>שם קבוצה:</label>
        <input value="${group}" onchange="renameGroup('${group}', this.value)">
        <button class="color-btn" onclick="openColorModal('${group}')">בחר צבע (לא חובה)</button>
        ${words.map((w,j) => `
          <label>מילה ${j+1}:</label>
          <input value="${w}" onchange="editingLevel.groups['${group}'][${j}]=this.value">
        `).join('')}
      </div>
    `).join('')}
    <button onclick="goToHint()">המשך</button>
    <button onclick="showLevelMenu()">חזור</button>
  `;
}

function renameGroup(oldName, newName) {
  if (!newName || oldName === newName) return;
  editingLevel.groups[newName] = editingLevel.groups[oldName];
  delete editingLevel.groups[oldName];
  if (editingLevel.colors?.[oldName]) {
    editingLevel.colors[newName] = editingLevel.colors[oldName];
    delete editingLevel.colors[oldName];
  }
  renderEditor();
}

function openColorModal(group) {
  tempColorGroup = group;
  document.getElementById("colorModal").style.display = "flex";
}

function closeColorModal() {
  document.getElementById("colorModal").style.display = "none";
}

function applyColor() {
  const color = document.getElementById("colorPicker").value;
  if (!editingLevel.colors) editingLevel.colors = {};
  editingLevel.colors[tempColorGroup] = color;
  closeColorModal();
}

function goToHint() {
  // validate
  let allWords = Object.values(editingLevel.groups).flat();
  if (allWords.length !== 16) {
    alert("יש להזין בדיוק 16 מילים (4 קבוצות של 4)");
    return;
  }

  document.body.innerHTML = `<h2>בחר רמז (2 מילים מתוך אותה קבוצה)</h2>
    <div class="hint-grid">
      ${allWords.map(word => `
        <div class="hint-tile ${hintSelected.includes(word) ? 'selected' : ''}"
          onclick="toggleHint('${word}')">${word}</div>
      `).join('')}
    </div>
    <br>
    <button onclick="confirmHint()">שמור</button>
    <button onclick="renderEditor()">חזור</button>
  `;
}

function toggleHint(word) {
  if (hintSelected.includes(word)) {
    hintSelected = hintSelected.filter(w => w !== word);
  } else if (hintSelected.length < 2) {
    hintSelected.push(word);
  }
  goToHint();
}

function confirmHint() {
  if (hintSelected.length !== 2) {
    alert("יש לבחור בדיוק שתי מילים");
    return;
  }
  let groupMatch = Object.values(editingLevel.groups).some(g => g.includes(hintSelected[0]) && g.includes(hintSelected[1]));
  if (!groupMatch) {
    alert("יש לבחור שתי מילים מתוך אותה קבוצה");
    return;
  }
  editingLevel.hintPair = hintSelected;
  saveLevel();
}

async function saveLevel() {
  editingLevel.words = Object.values(editingLevel.groups).flat();
  if (editingIndex === -1) {
    levels.push(editingLevel);
  } else {
    levels[editingIndex] = editingLevel;
  }

  const content = btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2))));
  const res0 = await fetch('https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json', {
    headers: { Authorization: 'token ' + token }
  });
  const sha = (await res0.json()).sha;

  const res = await fetch('https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json', {
    method: 'PUT',
    headers: {
      Authorization: 'token ' + token,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: "Update levels.json",
      content,
      sha
    })
  });

  alert("השלב נשמר!");
  hintSelected = [];
  showLevelMenu();
}

async function deleteLevel(index) {
  if (!confirm("בטוח שברצונך למחוק את השלב?")) return;
  levels.splice(index, 1);
  await saveLevel();
}
</script>

</body>
</html>