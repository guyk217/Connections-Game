<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ניהול שלבים</title>
  <style>
    body {
      font-family: sans-serif;
      background: #f9f9f9;
      padding: 20px;
      text-align: center;
      direction: rtl;
    }
    h1 {
      font-size: 24px;
      margin-bottom: 20px;
    }
    input, button, select {
      font-size: 18px;
      padding: 8px;
      margin: 6px 0;
      width: 100%;
      box-sizing: border-box;
    }
    .section {
      background: white;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      box-shadow: 0 2px 6px #ccc;
    }
    .group-title {
      font-weight: bold;
      margin-top: 10px;
    }
    .words-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-top: 5px;
    }
    .word-tile {
      padding: 8px 12px;
      border-radius: 6px;
      background: #eee;
      cursor: pointer;
      transition: 0.3s;
    }
    .word-tile:hover {
      background: #ddd;
    }
    .divider {
      border-top: 1px solid #ccc;
      margin: 15px 0;
    }
    .color-button {
      background: #ddd;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    .color-preview {
      display: inline-block;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      margin-right: 8px;
      vertical-align: middle;
    }
    .tile-selected {
      background: #b3d4fc !important;
    }
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="app"></div>

<script>
let levels = [];
let token = "";
let selectedLevelIndex = -1;
let currentEdit = null;
let hintSelection = [];
let isCreatingNew = false;

const REPO = "guyk217/Connections-Game";
const FILE = "levels.json";

function renderLogin() {
  document.getElementById("app").innerHTML = `
    <div class="section">
      <h1>🔐 התחברות</h1>
      <input id="tokenInput" placeholder="הכנס טוקן גישה" />
      <button onclick="handleLogin()">התחבר</button>
    </div>
  `;
}

async function handleLogin() {
  token = document.getElementById("tokenInput").value.trim();
  if (!token) return alert("נא להזין טוקן");
  await loadLevels();
}

async function loadLevels() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, {
      headers: { Authorization: `token ${token}` }
    });
    const data = await res.json();
    if (!data.content) throw "בעיה בקריאת הקובץ";
    levels = JSON.parse(atob(data.content));
    renderMenu();
  } catch (e) {
    alert("שגיאה בטעינת השלבים: " + e);
  }
}

function renderMenu() {
  let html = `
    <div class="section">
      <h1>🎛️ ניהול שלבים</h1>
      <button onclick="startCreate()">➕ צור שלב חדש</button>
      <div class="divider"></div>
      ${levels.map((lvl, i) => `
        <div>
          <b>${lvl.title}</b><br/>
          <button onclick="startEdit(${i})">✏️ ערוך</button>
          <button onclick="deleteLevel(${i})">🗑️ מחק</button>
        </div>
        <div class="divider"></div>
      `).join("")}
    </div>
  `;
  document.getElementById("app").innerHTML = html;
}

function startCreate() {
  currentEdit = {
    title: "שם השלב",
    groups: {
      "קבוצה 1": ["", "", "", ""],
      "קבוצה 2": ["", "", "", ""],
      "קבוצה 3": ["", "", "", ""],
      "קבוצה 4": ["", "", "", ""]
    },
    colors: {},
    hintPair: []
  };
  isCreatingNew = true;
  renderEditor();
}

function startEdit(index) {
  selectedLevelIndex = index;
  currentEdit = JSON.parse(JSON.stringify(levels[index]));
  isCreatingNew = false;
  renderEditor();
}

function renderEditor() {
  let html = `
    <div class="section">
      <h1 contenteditable="true" onblur="currentEdit.title=this.innerText">${currentEdit.title}</h1>
      ${Object.entries(currentEdit.groups).map(([group, words], idx) => `
        <div>
          <div class="group-title" contenteditable="true" onblur="renameGroup('${group}', this.innerText)">
            ${group}
          </div>
          <div class="words-row">
            ${words.map((word, i) => `
              <div class="word-tile" onclick="editWord('${group}', ${i})">${word}</div>
            `).join("")}
          </div>
          <div>
            <button class="color-button" onclick="pickColor('${group}')">
              <span class="color-preview" style="background:${currentEdit.colors?.[group] || '#fff'}"></span>
              בחר צבע (לא חובה)
            </button>
          </div>
        </div>
        <div class="divider"></div>
      `).join("")}
      <button onclick="goToHint()">המשך ↪️</button>
      <button onclick="renderMenu()">↩️ חזור</button>
    </div>
  `;
  document.getElementById("app").innerHTML = html;
}

function renameGroup(oldName, newName) {
  if (newName !== oldName) {
    currentEdit.groups[newName] = currentEdit.groups[oldName];
    delete currentEdit.groups[oldName];
    if (currentEdit.colors?.[oldName]) {
      currentEdit.colors[newName] = currentEdit.colors[oldName];
      delete currentEdit.colors[oldName];
    }
  }
  renderEditor();
}

function editWord(group, index) {
  let newWord = prompt("ערוך מילה:", currentEdit.groups[group][index]);
  if (newWord !== null) {
    currentEdit.groups[group][index] = newWord.trim();
    renderEditor();
  }
}

function pickColor(group) {
  let input = document.createElement("input");
  input.type = "color";
  input.value = currentEdit.colors?.[group] || "#ffffff";
  input.onchange = () => {
    currentEdit.colors[group] = input.value;
    renderEditor();
  };
  input.click();
}

function goToHint() {
  let allWords = Object.values(currentEdit.groups).flat();
  currentEdit.words = allWords;
  renderHintSelector();
}

function renderHintSelector() {
  let html = `
    <div class="section">
      <h1>💡 בחר רמז</h1>
      <p>בחר שתי מילים מאותה קבוצה בלבד</p>
      <div class="words-row">
        ${currentEdit.words.map(word => `
          <div class="word-tile ${hintSelection.includes(word) ? "tile-selected" : ""}" onclick="toggleHint('${word}')">${word}</div>
        `).join("")}
      </div>
      <button onclick="saveLevel()" ${hintSelection.length !== 2 ? "disabled" : ""}>💾 שמור</button>
      <button onclick="renderEditor()">↩️ חזור</button>
    </div>
  `;
  document.getElementById("app").innerHTML = html;
}

function toggleHint(word) {
  if (hintSelection.includes(word)) {
    hintSelection = hintSelection.filter(w => w !== word);
  } else if (hintSelection.length < 2) {
    hintSelection.push(word);
  }
  renderHintSelector();
}

function saveLevel() {
  // validate that both words in hint belong to the same group
  let valid = Object.values(currentEdit.groups).some(g => hintSelection.every(w => g.includes(w)));
  if (!valid) return alert("יש לבחור שתי מילים מאותה קבוצה בלבד.");
  currentEdit.hintPair = hintSelection;
  if (isCreatingNew) levels.push(currentEdit);
  else levels[selectedLevelIndex] = currentEdit;
  uploadLevels();
}

async function uploadLevels() {
  try {
    const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, {
      headers: { Authorization: `token ${token}` }
    });
    const data = await res.json();
    const sha = data.sha;

    const updated = {
      message: "עדכון שלבים",
      content: btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2)))),
      sha
    };

    const uploadRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${FILE}`, {
      method: "PUT",
      headers: {
        Authorization: `token ${token}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify(updated)
    });

    if (uploadRes.ok) {
      alert("השינויים נשמרו!");
      renderMenu();
    } else {
      alert("נכשל בשמירה");
    }
  } catch (e) {
    alert("שגיאה בשמירה: " + e);
  }
}

function deleteLevel(index) {
  if (confirm(`למחוק את "${levels[index].title}"?`)) {
    levels.splice(index, 1);
    uploadLevels();
  }
}

renderLogin();
</script>
</body>
</html>