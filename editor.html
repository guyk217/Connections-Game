<!DOCTYPE html>
<html dir="rtl" lang="he">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>עורך שלבים</title>
  <style>
    body { font-family: sans-serif; background: #fff8dc; padding: 20px; text-align: center; }
    h2 { margin-top: 0; }
    .group { border-top: 2px solid #ccc; margin-top: 20px; padding-top: 10px; }
    .words { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin: 5px 0; }
    .words input { width: 100px; text-align: center; }
    input, select, button { font-size: 16px; margin: 5px; padding: 5px; }
    .button-row { margin-top: 20px; }
    .tile { padding: 10px; border: 1px solid #ccc; background: white; cursor: pointer; }
    .tile.selected { background: lightgreen; }
    .tile.disabled { opacity: 0.4; pointer-events: none; }
    .grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
    .hidden { display: none; }
  </style>
</head>
<body>

<div id="loginScreen">
  <h2>🔐 הכנס את טוקן ה-Git שלך</h2>
  <input id="tokenInput" placeholder="הדבק כאן את הטוקן..." />
  <br />
  <button onclick="login()">המשך</button>
</div>

<div id="levelListScreen" class="hidden">
  <h2>בחר שלב לעריכה</h2>
  <div id="levelsList"></div>
  <button onclick="createNewLevel()">➕ שלב חדש</button>
</div>

<div id="editorScreen" class="hidden">
  <h2>✏️ עריכת שלב</h2>
  <input id="levelTitle" placeholder="שם השלב" style="width: 80%;" />
  <div id="groupsContainer"></div>
  <div>
    <label>קושי: </label>
    <select id="difficulty">
      <option>קל</option>
      <option>בינוני</option>
      <option>קשה</option>
    </select>
  </div>
  <div class="button-row">
    <button onclick="toHintScreen()">המשך לבחירת רמז</button>
  </div>
</div>

<div id="hintScreen" class="hidden">
  <h2>🎯 בחר רמז (2 מילים מאותה קבוצה)</h2>
  <div class="grid" id="wordGrid"></div>
  <div class="button-row">
    <button onclick="copyJSON()">📋 העתק JSON</button>
    <button onclick="copySHA()">🔑 העתק SHA</button>
    <button onclick="saveLevel()">💾 שמור</button>
  </div>
</div>

<script>
let token = '';
let levels = [];
let currentLevel = null;
let hint = [];
let sha = '';

function login() {
  token = document.getElementById('tokenInput').value.trim();
  if (!token) return alert("יש להזין טוקן");
  localStorage.setItem("token", token);
  loadLevels();
}

async function loadLevels() {
  document.getElementById('loginScreen').classList.add('hidden');
  document.getElementById('levelListScreen').classList.remove('hidden');

  const res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
    headers: { Authorization: `token ${token}` }
  });
  const data = await res.json();
  sha = data.sha;
  levels = JSON.parse(atob(data.content.replace(/\n/g, '')));
  const container = document.getElementById("levelsList");
  container.innerHTML = "";
  levels.forEach((lvl, i) => {
    const btn = document.createElement("button");
    btn.textContent = lvl.title;
    btn.onclick = () => editLevel(i);
    container.appendChild(btn);
  });
}

function createNewLevel() {
  currentLevel = {
    title: "",
    words: Array(16).fill(""),
    groups: {
      "קבוצה 1": ["", "", "", ""],
      "קבוצה 2": ["", "", "", ""],
      "קבוצה 3": ["", "", "", ""],
      "קבוצה 4": ["", "", "", ""]
    },
    hintPair: [],
    difficulty: "קל"
  };
  openEditor();
}

function editLevel(index) {
  currentLevel = JSON.parse(JSON.stringify(levels[index]));
  openEditor();
}

function openEditor() {
  document.getElementById('levelListScreen').classList.add('hidden');
  document.getElementById('editorScreen').classList.remove('hidden');
  document.getElementById('levelTitle').value = currentLevel.title;
  document.getElementById('difficulty').value = currentLevel.difficulty;
  renderGroups();
}

function renderGroups() {
  const container = document.getElementById("groupsContainer");
  container.innerHTML = "";
  let allWords = [];
  Object.entries(currentLevel.groups).forEach(([group, words], i) => {
    const div = document.createElement("div");
    div.className = "group";
    const input = document.createElement("input");
    input.value = group;
    input.oninput = e => {
      const newKey = e.target.value;
      if (newKey !== group) {
        currentLevel.groups[newKey] = currentLevel.groups[group];
        delete currentLevel.groups[group];
        renderGroups();
      }
    };
    div.appendChild(input);
    const wordInputs = document.createElement("div");
    wordInputs.className = "words";
    for (let j = 0; j < 4; j++) {
      const w = document.createElement("input");
      w.value = words[j] || "";
      w.oninput = e => {
        currentLevel.groups[input.value][j] = e.target.value;
        collectAllWords();
      };
      wordInputs.appendChild(w);
      allWords.push(w.value);
    }
    div.appendChild(wordInputs);
    container.appendChild(div);
  });
  collectAllWords();
}

function collectAllWords() {
  currentLevel.words = Object.values(currentLevel.groups).flat();
}

function toHintScreen() {
  currentLevel.title = document.getElementById("levelTitle").value;
  currentLevel.difficulty = document.getElementById("difficulty").value;
  document.getElementById('editorScreen').classList.add('hidden');
  document.getElementById('hintScreen').classList.remove('hidden');
  hint = [...(currentLevel.hintPair || [])];
  renderHintGrid();
}

function renderHintGrid() {
  const grid = document.getElementById("wordGrid");
  grid.innerHTML = "";
  currentLevel.words.forEach(word => {
    const tile = document.createElement("div");
    tile.className = "tile";
    tile.textContent = word;
    if (hint.includes(word)) tile.classList.add("selected");
    tile.onclick = () => toggleHint(word);
    grid.appendChild(tile);
  });
  applyHintRestriction();
}

function toggleHint(word) {
  if (hint.includes(word)) {
    hint = hint.filter(w => w !== word);
  } else {
    if (hint.length >= 2) return;
    hint.push(word);
  }
  renderHintGrid();
}

function applyHintRestriction() {
  const tiles = document.querySelectorAll(".tile");
  if (hint.length === 1) {
    const group = Object.values(currentLevel.groups).find(g => g.includes(hint[0]));
    tiles.forEach(tile => {
      if (!group.includes(tile.textContent) && !hint.includes(tile.textContent)) {
        tile.classList.add("disabled");
      } else {
        tile.classList.remove("disabled");
      }
    });
  } else {
    tiles.forEach(tile => tile.classList.remove("disabled"));
  }
  tiles.forEach(tile => {
    if (hint.includes(tile.textContent)) {
      tile.classList.add("selected");
    } else {
      tile.classList.remove("selected");
    }
  });
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => alert("📋 הועתק!"));
}

function copyJSON() {
  const updated = { ...currentLevel, hintPair: hint };
  const newLevels = [...levels];
  const i = newLevels.findIndex(l => l.title === updated.title);
  if (i >= 0) newLevels[i] = updated;
  else newLevels.push(updated);
  copyToClipboard(JSON.stringify(newLevels, null, 2));
}

function copySHA() {
  copyToClipboard(sha);
}

async function saveLevel() {
  if (hint.length !== 2) return alert("בחר 2 מילים לרמז");
  currentLevel.hintPair = hint;
  const i = levels.findIndex(l => l.title === currentLevel.title);
  if (i >= 0) levels[i] = currentLevel;
  else levels.push(currentLevel);
  const content = btoa(unescape(encodeURIComponent(JSON.stringify(levels, null, 2))));
  const res = await fetch("https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json", {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "Update levels",
      content,
      sha
    })
  });
  if (res.ok) {
    alert("✅ נשמר!");
    location.reload();
  } else {
    const text = await res.text();
    alert("שגיאה:\n" + text);
  }
}

window.onload = () => {
  token = localStorage.getItem("token") || "";
  if (token) login();
};
</script>
</body>
</html>