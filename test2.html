<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>בדיקת כתיבה ל-GitHub</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fff8dc; direction: rtl; }
    input, button { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; }
    pre { background: #eee; padding: 10px; overflow-x: auto; max-height: 300px; }
  </style>
</head>
<body>

<h1>בדיקת שמירה ל-GitHub</h1>
<input type="password" id="token" placeholder="הכנס טוקן GitHub (ghp_...)">
<button onclick="start()">בדוק כתיבה</button>
<pre id="log"></pre>

<script>
async function start() {
  const log = msg => document.getElementById('log').textContent += msg + '\n';
  const token = document.getElementById('token').value.trim();
  if (!token) return alert("הכנס טוקן");

  const apiUrl = "https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json";
  log("🔄 טוען קובץ...");

  const getRes = await fetch(apiUrl, {
    headers: { Authorization: `token ${token}` }
  });

  if (!getRes.ok) return log("❌ שגיאה בקריאה: " + getRes.status);

  const fileData = await getRes.json();
  const sha = fileData.sha;

  const decoded = decodeURIComponent(escape(atob(fileData.content)));
  const levels = JSON.parse(decoded);

  log("✅ נטען. מעתיק גיבוי לקליפבורד...");
  await navigator.clipboard.writeText(JSON.stringify(levels, null, 2));
  log("📋 נשמר לקליפבורד.");

  // הוספת שלב בדיקה
  levels.push({
    title: "בדיקת שמירה",
    difficulty: "קל",
    words: ["א", "ב", "ג", "ד", "1", "2", "3", "4", "!", "@", "#", "$", "one", "two", "three", "four"],
    groups: {
      "אותיות": ["א", "ב", "ג", "ד"],
      "מספרים": ["1", "2", "3", "4"],
      "סמלים": ["!", "@", "#", "$"],
      "מילים": ["one", "two", "three", "four"]
    },
    hintPair: ["א", "ב"]
  });

  const encoded = btoa(encodeURIComponent(JSON.stringify(levels, null, 2)).replace(/%([0-9A-F]{2})/g, (_, p1) =>
    String.fromCharCode('0x' + p1)
  ));

  log("📝 שומר קובץ...");
  const putRes = await fetch(apiUrl, {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "בדיקת כתיבה דרך test.html",
      content: encoded,
      sha: sha
    })
  });

  if (putRes.ok) {
    log("✅ נשמר בהצלחה!");
  } else {
    const error = await putRes.text();
    log("❌ שגיאה בשמירה: " + error);
  }
}
</script>

</body>
</html>