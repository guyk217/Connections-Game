<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>בדיקת שמירה ל-!!!GitHub</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #fff8dc; direction: rtl; }
    input, button { font-size: 16px; padding: 10px; width: 100%; margin-bottom: 10px; }
    pre { background: #eee; padding: 10px; overflow-x: auto; max-height: 300px; }
  </style>
</head>
<body>

<h1>בדיקת כתיבה ל־GitHub</h1>
<input type="password" id="token" placeholder="הכנס טוקן GitHub (ghp_...)">
<button onclick="start()">בדוק כתיבה</button>
<pre id="log"></pre>

<script>
async function start() {
  const log = msg => document.getElementById('log').textContent += msg + '\n';
  const token = document.getElementById('token').value.trim();
  if (!token) return alert("הכנס טוקן");

  const apiUrl = "https://api.github.com/repos/guyk217/Connections-Game/contents/levels.json";
  log("🔄 טוען קובץ...");

  const getRes = await fetch(apiUrl, {
    headers: { Authorization: `token ${token}` }
  });

  if (!getRes.ok) return log("❌ שגיאה בקריאה: " + getRes.status);

  const fileData = await getRes.json();
  const sha = fileData.sha;
  const content = atob(fileData.content.replace(/\n/g, ""));
  const levels = JSON.parse(content);

  // גיבוי לקליפבורד
  await navigator.clipboard.writeText(JSON.stringify(levels, null, 2));
  log("📋 נשמר לקליפבורד.");

  // הוספת שלב בדיקה
  levels.push({
    title: "בדיקת שמירה",
    difficulty: "קל",
    words: ["א", "ב", "ג", "ד", "1", "2", "3", "4", "!", "@", "#", "$", "one", "two", "three", "four"],
    groups: {
      "אותיות": ["א", "ב", "ג", "ד"],
      "מספרים": ["1", "2", "3", "4"],
      "סמלים": ["!", "@", "#", "$"],
      "מילים": ["one", "two", "three", "four"]
    },
    hintPair: ["א", "ב"]
  });

  // המרה נכונה ל־Base64 כולל עברית
  const encoder = new TextEncoder();
  const utf8 = encoder.encode(JSON.stringify(levels, null, 2));
  const binary = Array.from(utf8).map(b => String.fromCharCode(b)).join('');
  const base64 = btoa(binary);

  log("📝 שומר...");
  const putRes = await fetch(apiUrl, {
    method: "PUT",
    headers: {
      Authorization: `token ${token}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify({
      message: "בדיקת שמירה בעברית תקינה",
      content: base64,
      sha: sha
    })
  });

  if (putRes.ok) {
    log("✅ נשמר בהצלחה!");
  } else {
    const err = await putRes.text();
    log("❌ שגיאה בשמירה:\n" + err);
  }
}
</script>

</body>
</html>